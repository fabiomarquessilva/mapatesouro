<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ca√ßa ao Tesouro Pirata</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Leaflet CSS para o mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Verde claro para um tema de aventura */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        #app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Cantos mais arredondados */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #map {
            height: 300px; /* Altura fixa para o mapa */
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .message-box {
            background-color: #fff7ed;
            border-left: 4px solid #f97316;
            color: #ea580c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: left;
        }
        .message-box.info {
            background-color: #eff6ff;
            border-left-color: #3b82f6;
            color: #1d4ed8;
        }
        .button-primary {
            background-color: #10b981; /* Verde esmeralda */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
        }
        .button-primary:active:not(:disabled) {
            background-color: #047857;
            transform: translateY(0);
        }
        .button-disabled {
            background-color: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        .button-secondary { /* Estilo para o bot√£o Pular Pista */
            background-color: #6b7280; /* Cinza */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: normal;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
        }
        .button-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .button-secondary:active {
            background-color: #374151;
            transform: translateY(0);
        }
        .clue-card {
            background-color: #ecfdf5; /* Verde claro para a pista */
            border: 1px solid #a7f3d0;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: left;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .clue-card h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #065f46;
            margin-bottom: 0.75rem;
        }
        .clue-card p {
            font-size: 1.125rem;
            color: #064e3b;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom arrow icon styling */
        .custom-arrow-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 20px; /* Adjust as needed */
            height: 20px; /* Adjust as needed */
        }
        .custom-arrow-icon div {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid; /* Color will be set by JS */
            transform-origin: 50% 75%; /* Rotate around its base */
            transition: transform 0.1s linear; /* Smooth rotation */
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Ca√ßa ao Tesouro Pirata! üè¥‚Äç‚ò†Ô∏è</h1>

        <div id="start-screen">
            <p class="text-lg text-gray-600 mb-6">Prepare-se para uma aventura emocionante! Siga as pistas para encontrar o tesouro escondido.</p>
            <button id="startButton" class="button-primary">Iniciar Ca√ßa ao Tesouro</button>
        </div>

        <div id="game-screen" class="hidden">
            <div id="map"></div>
            <div id="status" class="text-gray-700 text-sm mt-2">Aguardando sua localiza√ß√£o...</div>
            <div id="clue-display" class="clue-card mt-4 hidden">
                <h2 id="clue-title">Pista Atual</h2>
                <p id="clue-text"></p>
                <p id="next-hint" class="text-gray-500 text-sm italic mt-2"></p>
            </div>
            <button id="foundClueButton" class="button-primary mt-4 button-disabled" disabled>Encontrei a Pista!</button>
            <button id="skipClueButton" class="button-secondary mt-2">Pular Pista</button>
            <div id="final-message" class="clue-card mt-4 hidden">
                <h2 class="text-2xl font-bold text-green-700">Tesouro Encontrado! üéâ</h2>
                <p class="text-lg text-green-800" id="secret-message"></p>
            </div>
            <div id="error-message" class="message-box hidden"></div>
            <div id="loading-indicator" class="loading-spinner hidden"></div>
        </div>
    </div>

    <script>
        // Game configuration
        const TREASURE_HUNT_CLUES = [
            {
                id: 0,
                latitude: -6.775780, // Pista Churrasqueira
                longitude: -38.240988,
                clueText: "Ol√°, pequena pirata! Sua primeira pista est√° na √°rea da churrasqueira. Observe as **quatro cadeiras amarelas** e o grande forno de pizza.",
                nextHint: "A pr√≥xima pista est√° onde os carros entram e saem do condom√≠nio, perto de um port√£o grande.",
                found: false
            },
            {
                id: 1,
                latitude: -6.776213, // Pista Guarita
                longitude: -38.241104,
                clueText: "Muito bem! Voc√™ encontrou a segunda pista na guarita! Observe a janela de vidro e o balc√£o onde o porteiro trabalha. Veja tamb√©m a **bicicleta de crian√ßa** que fica por perto!",
                nextHint: "A pr√≥xima pista est√° de volta √† √°rea da churrasqueira, mas preste aten√ß√£o na estrutura do telhado.",
                found: false
            },
            {
                id: 2,
                latitude: -6.775925, // Pista Churrasqueira (segunda vez)
                longitude: -38.240842,
                clueText: "Uau, voc√™ √© uma √≥tima ca√ßadora de tesouros! De volta √† churrasqueira! Agora, observe as cadeiras coloridas e a pia grande. A pr√≥xima pista est√° na sala de jogos.",
                nextHint: "A pr√≥xima pista est√° onde a divers√£o acontece, com mesas e brinquedos.",
                found: false
            },
            {
                id: 3,
                latitude: -6.775893, // Pista Sala de Jogos
                longitude: -38.241062,
                clueText: "Quase l√°! Voc√™ encontrou a pista da sala de jogos! Observe a mesa de sinuca e os jogos de tabuleiro. Agora, suba a escada do Bloco C, o tesouro est√° quase √† vista!",
                nextHint: "A pr√≥xima pista est√° onde voc√™ sobe para chegar no seu andar, no Bloco C.",
                found: false
            },
            {
                id: 4,
                latitude: -6.775842, // Pista Escada Bloco C
                longitude: -38.241144,
                clueText: "Excelente! Voc√™ est√° muito perto! Na escada do Bloco C, observe os corrim√£os e os degraus. A √°rea gourmet te espera com a pr√≥xima pista.",
                nextHint: "A pr√≥xima pista est√° onde se prepara comidas deliciosas, na √°rea gourmet.",
                found: false
            },
            {
                id: 5,
                latitude: -6.775936, // Pista √Årea Gourmet
                longitude: -38.241007,
                clueText: "Incr√≠vel! A √°rea gourmet revelou seu segredo! Observe o balc√£o da cozinha e os arm√°rios. Agora, v√° para onde o carro do papai est√° estacionado, o tesouro est√° quase em suas m√£os!",
                nextHint: "A pr√≥xima pista est√° perto do carro grande do papai.",
                found: false
            },
            {
                id: 6,
                latitude: -6.775940, // Pista Carro do Papai
                longitude: -38.241271,
                clueText: "Parab√©ns, aventureira! Voc√™ encontrou a √∫ltima pista! Observe o carro do papai e o estacionamento ao redor. Agora, o tesouro final te espera no lugar mais especial de todos...",
                nextHint: "Volte para o seu apartamento, o segredo final est√° te esperando l√°!",
                found: false
            }
        ];

        const FINAL_SECRET_MESSAGE = "Volte para seu apartamento e d√™ um abra√ßo na mam√£e!";
        // Raio em metros para o bot√£o "Encontrei a Pista!" ficar ativo
        const PROXIMITY_RADIUS_FOR_BUTTON_ACTIVATION = 100; 

        let currentClueIndex = 0;
        let watchId; // Para armazenar o ID do watchPosition
        let map;
        let userMarker;
        let clueMarker;
        let proximityCircle; // Para o c√≠rculo de proximidade
        let directionArrowMarker; // Marcador para a seta direcional
        let lastKnownHeading = 0; // Armazena a √∫ltima dire√ß√£o (b√∫ssola) conhecida do dispositivo
        let isMapInitialized = false; // Flag para rastrear a inicializa√ß√£o do mapa

        // Elementos DOM
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const clueDisplay = document.getElementById('clue-display');
        const clueTitle = document.getElementById('clue-title');
        const clueText = document.getElementById('clue-text');
        const nextHint = document.getElementById('next-hint');
        const foundClueButton = document.getElementById('foundClueButton');
        const skipClueButton = document.getElementById('skipClueButton');
        const finalMessageDiv = document.getElementById('final-message');
        const secretMessageP = document.getElementById('secret-message');
        const errorMessageDiv = document.getElementById('error-message');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Fun√ß√£o para exibir uma caixa de mensagem
        function showMessageBox(message, type = 'error') {
            console.log("Mostrando mensagem:", message);
            errorMessageDiv.textContent = message;
            errorMessageDiv.className = `message-box ${type === 'info' ? 'info' : ''}`;
            errorMessageDiv.classList.remove('hidden');
        }

        // Fun√ß√£o para esconder a caixa de mensagem
        function hideMessageBox() {
            console.log("Escondendo mensagem.");
            errorMessageDiv.classList.add('hidden');
        }

        // Fun√ß√£o para exibir o indicador de carregamento
        function showLoading() {
            console.log("Mostrando indicador de carregamento.");
            loadingIndicator.classList.remove('hidden');
        }

        // Fun√ß√£o para esconder o indicador de carregamento
        function hideLoading() {
            console.log("Escondendo indicador de carregamento.");
            loadingIndicator.classList.add('hidden');
        }

        // Fun√ß√£o para inicializar o mapa
        function initMap(latitude, longitude) {
            console.log("Tentando inicializar mapa em:", latitude, longitude);
            // Verifica se a biblioteca Leaflet (L) est√° definida antes de us√°-la
            if (typeof L === 'undefined') {
                console.error("Leaflet (L) n√£o est√° definido. N√£o √© poss√≠vel inicializar o mapa.");
                showMessageBox("Erro ao carregar o mapa. Verifique sua conex√£o com a internet.", 'error');
                return;
            }

            try {
                if (map) {
                    map.remove(); // Remove o mapa existente, se houver
                    console.log("Mapa existente removido.");
                }
                map = L.map('map').setView([latitude, longitude], 17); // Vis√£o inicial com zoom
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                isMapInitialized = true; // Define a flag como true ap√≥s a inicializa√ß√£o do mapa
                console.log("Mapa inicializado. isMapInitialized =", isMapInitialized);
            } catch (error) {
                console.error("Erro ao inicializar o mapa:", error);
                showMessageBox("Erro ao inicializar o mapa. Tente recarregar a p√°gina.", 'error');
            }
        }

        // Fun√ß√£o para atualizar a posi√ß√£o do marcador do usu√°rio no mapa
        function updateUserMarker(latitude, longitude) {
            console.log("Atualizando marcador do usu√°rio para:", latitude, longitude);
            if (!isMapInitialized) {
                console.log("Mapa n√£o inicializado, n√£o √© poss√≠vel atualizar marcador do usu√°rio.");
                return;
            }

            try {
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                    map.setView([latitude, longitude]); // Mant√©m o mapa centralizado no usu√°rio
                } else {
                    // Se o mapa j√° est√° inicializado mas o marcador do usu√°rio n√£o, crie-o
                    userMarker = L.marker([latitude, longitude]).addTo(map)
                        .bindPopup("Voc√™ est√° aqui!")
                        .openPopup();
                    console.log("Marcador do usu√°rio criado e adicionado ao mapa.");
                }
            } catch (error) {
                console.error("Erro ao atualizar marcador do usu√°rio:", error);
            }
        }

        // Fun√ß√£o para atualizar a posi√ß√£o do marcador da pista e o c√≠rculo no mapa
        function updateClueMarkerAndCircle() {
            console.log("Atualizando marcador da pista e c√≠rculo.");
            // Garante que o mapa esteja inicializado antes de adicionar o marcador da pista
            if (!isMapInitialized) {
                console.log("Mapa n√£o inicializado, n√£o √© poss√≠vel atualizar marcador da pista/c√≠rculo.");
                return;
            }

            try {
                if (clueMarker) {
                    map.removeLayer(clueMarker); // Remove o marcador da pista antiga
                    console.log("Marcador de pista antigo removido.");
                }
                if (proximityCircle) {
                    map.removeLayer(proximityCircle); // Remove o c√≠rculo antigo
                    console.log("C√≠rculo de proximidade antigo removido.");
                }

                const targetClue = TREASURE_HUNT_CLUES[currentClueIndex];
                if (targetClue) {
                    clueMarker = L.marker([targetClue.latitude, targetClue.longitude]).addTo(map)
                        .bindPopup("Pr√≥xima Pista!");
                    console.log("Novo marcador de pista adicionado em:", targetClue.latitude, targetClue.longitude);

                    // Adiciona o c√≠rculo de proximidade
                    proximityCircle = L.circle([targetClue.latitude, targetClue.longitude], {
                        color: 'blue',
                        fillColor: '#30f',
                        fillOpacity: 0.2,
                        radius: PROXIMITY_RADIUS_FOR_BUTTON_ACTIVATION
                    }).addTo(map);
                    console.log("C√≠rculo de proximidade adicionado com raio:", PROXIMITY_RADIUS_FOR_BUTTON_ACTIVATION);
                }
            } catch (error) {
                console.error("Erro ao atualizar marcador da pista e c√≠rculo:", error);
            }
        }

        // Fun√ß√£o para calcular a dist√¢ncia entre duas coordenadas (f√≥rmula de Haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metros
            const œÜ1 = lat1 * Math.PI / 180; // œÜ, Œª em radianos
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // em metros
            return d;
        }

        // Fun√ß√£o para calcular o rolamento (bearing) entre dois pontos
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRadians = (deg) => deg * Math.PI / 180;
            const toDegrees = (rad) => rad * 180 / Math.PI;

            const œÜ1 = toRadians(lat1);
            const œÜ2 = toRadians(lat2);
            const ŒîŒª = toRadians(lon2 - lon1);

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            let bearing = toDegrees(Math.atan2(y, x));
            return (bearing + 360) % 360; // Normaliza para 0-360
        }

        // Fun√ß√£o para atualizar a dire√ß√£o e a cor da seta
        function updateArrowDirectionAndColor() {
            console.log("Atualizando dire√ß√£o e cor da seta.");
            if (!isMapInitialized || !userMarker || currentClueIndex >= TREASURE_HUNT_CLUES.length) {
                console.log("N√£o √© poss√≠vel atualizar a seta: mapa n√£o inicializado ou todas as pistas encontradas.");
                // Mapa n√£o pronto, marcador do usu√°rio n√£o definido ou todas as pistas encontradas
                if (directionArrowMarker) {
                    map.removeLayer(directionArrowMarker);
                    directionArrowMarker = null;
                    console.log("Marcador de seta removido.");
                }
                return;
            }

            try {
                const userLatLng = userMarker.getLatLng();
                const currentClue = TREASURE_HUNT_CLUES[currentClueIndex];
                const targetLatLng = L.latLng(currentClue.latitude, currentClue.longitude);

                // Calcula o rolamento do usu√°rio para o alvo
                const bearingToTarget = calculateBearing(
                    userLatLng.lat, userLatLng.lng,
                    targetLatLng.lat, targetLatLng.lng
                );

                // Calcula o √¢ngulo de rota√ß√£o da seta em rela√ß√£o √† orienta√ß√£o do dispositivo
                // A seta aponta para o alvo, mas sua rota√ß√£o √© relativa √† b√∫ssola do dispositivo
                const rotationAngle = bearingToTarget - lastKnownHeading;

                // Calcula a diferen√ßa angular absoluta para determinar a cor
                let angleDiffAbs = Math.abs(lastKnownHeading - bearingToTarget);
                let normalizedAngleDiff = Math.min(angleDiffAbs, 360 - angleDiffAbs);

                // Determina a cor da seta com base no alinhamento (ex: dentro de +/- 30 graus)
                const isCorrectDirection = normalizedAngleDiff <= 30; // Dentro de 30 graus do alvo
                const arrowColor = isCorrectDirection ? '#10b981' : '#ef4444'; // Verde ou Vermelho

                // Cria ou atualiza o √≠cone personalizado da seta
                const arrowIconHtml = `
                    <div style="
                        width: 0;
                        height: 0;
                        border-left: 10px solid transparent;
                        border-right: 10px solid transparent;
                        border-bottom: 20px solid ${arrowColor};
                        transform: rotate(${rotationAngle}deg); /* Gira a seta */
                        transform-origin: 50% 75%; /* Gira em torno de sua base */
                        transition: transform 0.1s linear; /* Smooth rotation */
                    "></div>
                `;

                const customArrowIcon = L.divIcon({
                    className: 'custom-arrow-icon',
                    html: arrowIconHtml,
                    iconSize: [20, 20], // Tamanho da div da seta
                    iconAnchor: [10, 20] // Ponto de ancoragem (centro inferior da seta)
                });

                if (!directionArrowMarker) {
                    directionArrowMarker = L.marker(userLatLng, { icon: customArrowIcon }).addTo(map);
                    console.log("Marcador de seta criado.");
                } else {
                    directionArrowMarker.setLatLng(userLatLng);
                    directionArrowMarker.setIcon(customArrowIcon);
                    console.log("Marcador de seta atualizado.");
                }
            } catch (error) {
                console.error("Erro ao atualizar seta direcional:", error);
            }
        }

        // Manipulador de eventos de orienta√ß√£o do dispositivo (b√∫ssola)
        function handleOrientation(event) {
            // alpha √© a dire√ß√£o da b√∫ssola (0-360 graus, 0 √© Norte)
            if (event.alpha !== null) {
                lastKnownHeading = event.alpha;
                updateArrowDirectionAndColor();
            }
        }

        // Fun√ß√£o para exibir a pista atual
        function displayClue() {
            console.log("Dentro de displayClue(). currentClueIndex:", currentClueIndex);
            const clue = TREASURE_HUNT_CLUES[currentClueIndex];
            if (clue) {
                console.log("Pista a ser exibida:", clue.clueText);
                clueTitle.textContent = `Pista ${currentClueIndex + 1}`;
                clueText.textContent = clue.clueText;
                nextHint.textContent = `Dica: ${clue.nextHint}`;
                clueDisplay.classList.remove('hidden'); // Isso deve tornar o elemento vis√≠vel
                console.log("clue-display deveria estar vis√≠vel.");
                foundClueButton.classList.add('button-disabled'); // Desabilita o bot√£o ao exibir nova pista
                foundClueButton.disabled = true;

                // Atualiza o mapa e a seta SOMENTE se o mapa j√° estiver inicializado
                if (isMapInitialized) {
                    console.log("Mapa inicializado, atualizando marcadores e seta.");
                    updateClueMarkerAndCircle(); // Atualiza o marcador da pista e o c√≠rculo no mapa
                    updateArrowDirectionAndColor(); // Atualiza a seta direcional para a nova pista
                } else {
                    console.log("Mapa ainda n√£o inicializado, marcadores e seta aguardando a primeira localiza√ß√£o GPS.");
                }
            } else {
                console.log("Todas as pistas encontradas ou √≠ndice de pista inv√°lido. Exibindo mensagem final.");
                // Todas as pistas encontradas, exibe a mensagem final
                clueDisplay.classList.add('hidden');
                foundClueButton.classList.add('hidden'); // Esconde o bot√£o
                skipClueButton.classList.add('hidden'); // Esconde o bot√£o Pular Pista
                finalMessageDiv.classList.remove('hidden');
                secretMessageP.textContent = FINAL_SECRET_MESSAGE;
                statusDiv.textContent = "Tesouro Encontrado!";
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId); // Para de observar a localiza√ß√£o
                    console.log("Observa√ß√£o de localiza√ß√£o parada.");
                }
                if (clueMarker) {
                    map.removeLayer(clueMarker); // Remove o marcador da pista
                    console.log("Marcador de pista removido.");
                }
                if (proximityCircle) { // Remove o c√≠rculo de proximidade
                    map.removeLayer(proximityCircle);
                    console.log("C√≠rculo de proximidade removido.");
                }
                // Remove o marcador da seta direcional quando o jogo termina
                if (directionArrowMarker) {
                    map.removeLayer(directionArrowMarker);
                    directionArrowMarker = null;
                    console.log("Marcador de seta direcional removido.");
                }
                // Remove o listener de orienta√ß√£o do dispositivo
                window.removeEventListener('deviceorientation', handleOrientation);
                console.log("Listener de orienta√ß√£o do dispositivo removido.");
            }
        }

        // Callback de sucesso para geolocaliza√ß√£o
        function geolocationSuccess(position) {
            console.log("Sucesso na geolocaliza√ß√£o. Posi√ß√£o:", position.coords.latitude, position.coords.longitude, "Precis√£o:", position.coords.accuracy);
            hideLoading();
            hideMessageBox();

            const { latitude, longitude, accuracy } = position.coords;
            statusDiv.textContent = `Sua localiza√ß√£o: Lat ${latitude.toFixed(5)}, Lon ${longitude.toFixed(5)} (Precis√£o: ${accuracy.toFixed(1)}m)`;

            // Inicializa o mapa SOMENTE AQUI, quando a primeira localiza√ß√£o √© obtida
            if (!isMapInitialized) {
                console.log("Mapa n√£o inicializado. Chamando initMap com localiza√ß√£o atual.");
                initMap(latitude, longitude); // Inicializa com a localiza√ß√£o atual do usu√°rio
            }
            
            // Sempre atualiza o marcador do usu√°rio no mapa
            updateUserMarker(latitude, longitude);

            // Garante que a seta e o c√≠rculo sejam atualizados com a nova posi√ß√£o do usu√°rio
            if (isMapInitialized) {
                console.log("Mapa inicializado, atualizando marcadores de pista e seta.");
                updateClueMarkerAndCircle();
                updateArrowDirectionAndColor();
            }

            // Para atualiza√ß√µes de localiza√ß√£o subsequentes, verifica a proximidade da pista
            const currentClue = TREASURE_HUNT_CLUES[currentClueIndex];
            if (currentClue && !currentClue.found) {
                const distance = getDistance(latitude, longitude, currentClue.latitude, currentClue.longitude);
                statusDiv.textContent += ` | Dist√¢ncia para a pr√≥xima pista: ${distance.toFixed(1)}m`;
                console.log("Dist√¢ncia para a pr√≥xima pista:", distance.toFixed(1), "m");

                // Ativa/desativa o bot√£o "Encontrei a Pista!"
                if (distance <= PROXIMITY_RADIUS_FOR_BUTTON_ACTIVATION) {
                    if (foundClueButton.disabled) {
                        console.log("Bot√£o 'Encontrei a Pista!' ativado.");
                    }
                    foundClueButton.classList.remove('button-disabled');
                    foundClueButton.disabled = false;
                } else {
                    if (!foundClueButton.disabled) {
                        console.log("Bot√£o 'Encontrei a Pista!' desativado.");
                    }
                    foundClueButton.classList.add('button-disabled');
                    foundClueButton.disabled = true;
                }
            }
        }

        // Callback de erro para geolocaliza√ß√£o
        function geolocationError(error) {
            console.error("Erro na geolocaliza√ß√£o:", error.code, error.message);
            hideLoading();
            let message = "Erro ao obter a localiza√ß√£o.";
            let troubleshootingTip = "";

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiss√£o de localiza√ß√£o negada.";
                    if (error.message.includes("permissions policy")) {
                        troubleshootingTip = "Este jogo est√° sendo executado em um ambiente que bloqueia o acesso √† sua localiza√ß√£o (pol√≠tica de permiss√µes). Para continuar a brincadeira, voc√™ pode usar o bot√£o 'Pular Pista' para avan√ßar manualmente.";
                    } else {
                        troubleshootingTip = "Por favor, habilite a localiza√ß√£o nas configura√ß√µes do seu navegador ou do site. Verifique tamb√©m as configura√ß√µes de privacidade do seu aparelho.";
                    }
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Informa√ß√µes de localiza√ß√£o indispon√≠veis.";
                    troubleshootingTip = "O sinal de GPS pode estar fraco ou bloqueado. Tente ir para uma √°rea aberta.";
                    break;
                case error.TIMEOUT:
                    message = "Tempo limite excedido ao tentar obter a localiza√ß√£o.";
                    troubleshootingTip = "O sinal pode estar demorando muito para ser obtido. Tente recarregar a p√°gina ou ir para uma √°rea com melhor sinal.";
                    break;
                default:
                    message = "Ocorreu um erro desconhecido ao tentar obter a localiza√ß√£o.";
                    troubleshootingTip = "Tente recarregar a p√°gina ou verificar as configura√ß√µes do seu navegador.";
                    break;
            }
            showMessageBox(`${message} ${troubleshootingTip}`, 'error');
            statusDiv.textContent = message;
        }

        // Fun√ß√£o para ativar a pr√≥xima pista manualmente
        function activateClueManually() {
            console.log("Bot√£o 'Encontrei a Pista!' clicado.");
            const currentClue = TREASURE_HUNT_CLUES[currentClueIndex];
            if (currentClue && !currentClue.found) {
                currentClue.found = true;
                showMessageBox(`Pista ${currentClueIndex + 1} encontrada!`, 'info');
                setTimeout(() => {
                    hideMessageBox();
                    currentClueIndex++;
                    displayClue(); // Exibe a pr√≥xima pista ou a mensagem final
                }, 1500); // Exibe a mensagem por 1.5 segundos
            }
        }

        // Fun√ß√£o para pular a pista (controle parental)
        function skipClue() {
            console.log("Bot√£o 'Pular Pista' clicado.");
            if (currentClueIndex < TREASURE_HUNT_CLUES.length) {
                showMessageBox(`Pista ${currentClueIndex + 1} pulada!`, 'info');
                TREASURE_HUNT_CLUES[currentClueIndex].found = true; // Marca como encontrada para n√£o voltar
                setTimeout(() => {
                    hideMessageBox();
                    currentClueIndex++;
                    displayClue(); // Exibe a pr√≥xima pista ou a mensagem final
                }, 1500);
            }
        }

        // Inicia a ca√ßa ao tesouro
        startButton.addEventListener('click', () => {
            console.log("Bot√£o 'Iniciar Ca√ßa ao Tesouro' clicado.");
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            console.log("Tela do jogo vis√≠vel.");
            showLoading();

            // Exibe a primeira pista imediatamente ao iniciar o jogo (texto apenas)
            displayClue();
            console.log("displayClue() chamado no in√≠cio para exibir texto da pista.");

            if (navigator.geolocation) {
                console.log("Iniciando watchPosition para geolocaliza√ß√£o.");
                watchId = navigator.geolocation.watchPosition(
                    geolocationSuccess,
                    geolocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 5000
                    }
                );

                // Solicita permiss√£o para DeviceOrientationEvent em iOS 13+
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    console.log("Tentando solicitar permiss√£o de orienta√ß√£o do dispositivo (iOS 13+).");
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                                console.log("Permiss√£o de orienta√ß√£o do dispositivo concedida.");
                            } else {
                                console.log("Permiss√£o de orienta√ß√£o do dispositivo negada.");
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao solicitar permiss√£o de orienta√ß√£o:", error);
                        });
                } else {
                    // Para navegadores que n√£o s√£o iOS 13+ ou vers√µes mais antigas do Safari
                    console.log("Adicionando listener de orienta√ß√£o do dispositivo (n√£o iOS 13+).");
                    window.addEventListener('deviceorientation', handleOrientation);
                }

            } else {
                showMessageBox("Seu navegador n√£o suporta geolocaliza√ß√£o. Por favor, use um navegador compat√≠vel.", 'error');
                hideLoading();
                console.log("Navegador n√£o suporta geolocaliza√ß√£o.");
            }
        });

        // Adiciona o listener para o bot√£o "Encontrei a Pista!"
        foundClueButton.addEventListener('click', activateClueManually);
        // Adiciona o listener para o bot√£o "Pular Pista"
        skipClueButton.addEventListener('click', skipClue);

        // Configura√ß√£o inicial ao carregar a janela
        window.addEventListener('load', () => {
            console.log("P√°gina carregada.");
            // O mapa ser√° carregado quando o GPS for obtido pela primeira vez
        });
    </script>
</body>
</html>

