<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relatório - CER-Breve-14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .email-preview, .training-content {
            white-space: pre-wrap; /* Mantém as quebras de linha e espaços */
            word-wrap: break-word; /* Quebra palavras longas */
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            color: #333;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
        }
        .training-content h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .training-content ul {
            list-style-type: disc;
            margin-left: 2rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-screen" class="min-h-screen flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="text-lg font-medium mt-4">Carregando Aplicação...</p>
    </div>

    <div id="app-container" class="p-4 sm:p-8 hidden">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
            
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 text-center">Gerador de Relatório</h1>
                <p class="text-center text-gray-600 mt-2">Escala de Coping Religioso-Espiritual (CER-Breve-14)</p>
            </div>

            <!-- Tela 0: Boas-vindas -->
            <div id="welcome-screen">
                <h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">Bem-vindo, Extensionista!</h2>
                <p class="text-center text-gray-600 mb-8">Para garantir a qualidade da coleta, o treinamento é obrigatório antes do primeiro uso.</p>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                    <button id="show-training-btn" class="w-full sm:w-1/2 py-3 px-6 text-white font-semibold bg-gray-500 rounded-md hover:bg-gray-600">Iniciar/Refazer Treinamento</button>
                    <button id="start-collection-btn" class="w-full sm:w-1/2 py-3 px-6 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Iniciar Coleta de Dados</button>
                </div>
                <p id="training-status" class="text-center mt-4 text-sm"></p>
            </div>
            
            <!-- Tela do Treinamento -->
            <div id="training-screen" class="hidden">
                 <div id="training-step-content" class="training-content">
                    <!-- Conteúdo do passo do treinamento será inserido aqui -->
                 </div>
                 <div id="training-question-container" class="mt-6">
                    <!-- Pergunta e opções serão inseridas aqui -->
                 </div>
                 <div id="training-feedback" class="mt-4 font-semibold"></div>
                 <div class="flex justify-between items-center mt-8">
                    <button id="back-to-welcome-btn" class="text-sm text-gray-600 hover:text-gray-800">&larr; Voltar para a Tela Inicial</button>
                    <button id="next-step-btn" class="py-2 px-6 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700">Próximo</button>
                 </div>
            </div>

            <!-- Tela de Resultado do Treinamento -->
            <div id="training-result-screen" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Resultado do Treinamento</h2>
                <p class="text-lg mb-2">Sua pontuação foi de <span id="training-score" class="font-bold"></span>.</p>
                <p id="training-result-message" class="text-lg font-semibold mb-6"></p>
                <div id="training-result-actions">
                    <!-- Botões de ação (tentar novamente ou continuar) serão inseridos aqui -->
                </div>
            </div>

            <!-- Tela 1: Informações do Aluno -->
            <div id="student-info-screen" class="hidden">
                <form id="student-form" class="space-y-6">
                    <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">1. Identificação do Extensionista</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Seu Nome Completo</label>
                            <input type="text" id="student-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Sua Matrícula</label>
                            <input type="text" id="student-id" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Seu Telefone / WhatsApp</label>
                            <input type="tel" id="student-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                    </div>
                    <div class="text-center pt-4">
                         <button type="submit" class="w-full md:w-1/2 py-2 px-4 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700">Próximo</button>
                    </div>
                </form>
            </div>

            <!-- Tela 2: Seleção de Projeto -->
            <div id="project-selection-screen" class="hidden">
                 <h3 class="text-xl font-semibold mb-6 pb-2 border-b-2 border-gray-400 text-gray-700 text-center">2. Selecione o Projeto</h3>
                 <div id="project-buttons-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Botões serão inseridos aqui -->
                 </div>
                 <div class="text-center mt-8">
                    <button id="back-to-student-info" class="text-sm text-gray-600 hover:text-gray-800">&larr; Alterar dados do Extensionista</button>
                 </div>
            </div>

            <!-- Tela 3: Coleta de Dados do Público Alvo -->
            <div id="data-collection-screen" class="hidden">
                <form id="data-form" class="space-y-8">
                    <!-- Dados do Participante -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">3. Informações do Participante</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome do Participante</label>
                                <input type="text" id="participant-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Idade do Participante</label>
                                <input type="number" id="participant-age" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Sexo do Participante</label>
                                <select id="participant-sex" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white">
                                    <option value="">Selecione...</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Seção da Escala -->
                    <div id="questions-container">
                        <h3 id="questions-title" class="text-xl font-semibold mb-2">4. Escala CER-Breve-14</h3>
                        <p id="questions-intro" class="p-4 rounded-md italic">
                            <!-- Instrução inserida pelo JS -->
                        </p>
                        <div id="questions-list" class="space-y-6 mt-6">
                            <!-- Perguntas inseridas pelo JS -->
                        </div>
                    </div>

                    <!-- Seção de Submissão -->
                    <div class="text-center pt-4">
                        <div id="status-message" class="mb-4 font-semibold"></div>
                        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                             <button type="button" id="back-to-project-selection" class="text-sm text-gray-600 hover:text-gray-800 order-2 sm:order-1">&larr; Voltar para Seleção de Projeto</button>
                            <button type="submit" id="submit-button" class="w-full md:w-2/3 py-3 px-6 text-white font-bold text-lg rounded-lg shadow-md transition bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 order-1 sm:order-2">
                                Pré-visualizar Mensagem
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tela 4: Pré-visualização da Mensagem -->
            <div id="preview-screen" class="hidden">
                <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">5. Pré-visualização do E-mail</h3>
                <p class="text-sm text-gray-600 mb-4">Este é o corpo do e-mail que será enviado. Por favor, revise antes de continuar.</p>
                <div id="preview-message" class="email-preview">
                    <!-- Mensagem formatada será inserida aqui -->
                </div>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8">
                    <button type="button" id="back-to-form-btn" class="text-sm text-gray-600 hover:text-gray-800 order-2 sm:order-1">&larr; Voltar e Editar</button>
                    <button type="button" id="send-by-email-btn" class="w-full md:w-1/2 py-3 px-6 text-white font-bold text-lg rounded-lg shadow-md transition bg-green-600 hover:bg-green-700 order-1 sm:order-2">
                        Abrir Programa de E-mail
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuração dos Projetos e Perguntas ---
            const projectConfig = {
              idosos: { name: "Idosos Institucionalizados (Abrigo Lucas Zorn)", whatsapp: "5584994420139", color: "green", bgColor: "bg-green-50", textColor: "text-green-800", buttonColor: "bg-green-600", intro: "Vou te fazer umas perguntas bem simples sobre sua fé ou sua ligação com Deus, tá certo? Não tem resposta certa ou errada, é só o que você sente, tá bom?", questions: [ { id: 1, adaptada: "O(a) senhor(a) sentiu vontade de se aproximar mais de Deus, conversar mais com Ele nesses últimos tempos?" }, { id: 2, adaptada: "Teve momentos que o(a) senhor(a) sentiu que precisava do carinho ou da proteção de Deus?" }, { id: 3, adaptada: "Rezou ou conversou com Deus pedindo ajuda, conforto ou um conselho sobre o que fazer?" }, { id: 4, adaptada: "O(a) senhor(a) procurou se fortalecer em Deus quando as coisas estavam difíceis?" }, { id: 5, adaptada: "O(a) senhor(a) costuma rezar por outras pessoas, como amigos, família, colegas daqui do abrigo?" }, { id: 6, adaptada: "O(a) senhor(a) chegou a pensar que essa situação pode estar servindo pra te tornar mais forte com a ajuda de Deus?" }, { id: 7, adaptada: "Sentiu vontade de conversar com Deus pra pedir perdão por algo que acredita que fez de errado?" }, { id: 8, adaptada: "Teve algum momento que sentiu como se Deus tivesse te deixado sozinho(a)?" }, { id: 9, adaptada: "Já pensou se Deus realmente te ama ou se te esqueceu?" }, { id: 10, adaptada: "Já sentiu que Deus tá te castigando por algo?" }, { id: 11, adaptada: "Já ficou com raiva de Deus por tudo que tá passando?" }, { id: 12, adaptada: "Pensou que tudo isso que está vivendo pode ser um castigo de Deus?" }, { id: 13, adaptada: "Acredita que Deus está te provando ou testando com essa situação?" }, { id: 14, adaptada: "Teve dias em que ficou difícil acreditar ou confiar em Deus?" }, ] },
              cuidadores: { name: "Cuidadores de CRIANES (APAE)", whatsapp: "5583999992617", color: "pink", bgColor: "bg-pink-50", textColor: "text-pink-800", buttonColor: "bg-pink-600", intro: "A gente quer entender como a fé ajuda (ou não ajuda) no seu dia a dia com a criança. Pode responder como se estivesse contando sua rotina pra um amigo, tudo certo?", questions: [ { id: 1, adaptada: "Você buscou se aproximar mais de Deus nos momentos difíceis com seu filho(a)?" }, { id: 2, adaptada: "Sentiu que precisava da proteção de Deus diante dos desafios de cuidar da criança?" }, { id: 3, adaptada: "Você rezou ou meditou pedindo orientação ou consolo em situações difíceis?" }, { id: 4, adaptada: "Buscou forças em Deus para continuar luting pelo cuidado da criança?" }, { id: 5, adaptada: "Você costuma rezar por outras pessoas, como por seu(sua) filho(a), familiares ou amigos?" }, { id: 6, adaptada: "Já pensou que Deus pode estar te dando força para enfrentar tudo isso?" }, { id: 7, adaptada: "Você pediu perdão a Deus por algo que acha que poderia ter feito diferente?" }, { id: 8, adaptada: "Sentiu que Deus te deixou sozinha(o) nesse cuidado todo?" }, { id: 9, adaptada: "Já teve dúvida se Deus te ama mesmo diante de tanto sofrimento?" }, { id: 10, adaptada: "Você pensou que tudo isso pode ser um castigo de Deus?" }, { id: 11, adaptada: "Já ficou com raiva de Deus por tudo que está vivendo?" }, { id: 12, adaptada: "Acreditou que os problemas são um castigo?" }, { id: 13, adaptada: "Você sentiu que tudo isso é um teste de Deus pra você?" }, { id: 14, adaptada: "Teve dificuldade em acreditar ou confiar em Deus durante esse processo?" }, ] },
              dependentes: { name: "Usuários do CAPS AD (Dependentes Químicos)", whatsapp: "5583991007459", color: "orange", bgColor: "bg-orange-50", textColor: "text-orange-800", buttonColor: "bg-orange-600", intro: "A gente quer saber como a sua fé ou sua relação com Deus tem influenciado no seu tratamento. Pode responder com sinceridade, sem julgamento.", questions: [ { id: 1, adaptada: "Você tentou se aproximar mais de Deus nesse tempo de tratamento?" }, { id: 2, adaptada: "Buscou proteção e carinho de Deus nas horas difíceis?" }, { id: 3, adaptada: "Você orou, meditou ou conversou com Deus pedindo ajuda ou clareza?" }, { id: 4, adaptada: "Sentiu que precisava buscar forças em Deus pra vencer as recaídas ou a abstinência?" }, { id: 5, adaptada: "Você rezou por outras pessoas, como amigos, família ou colegas daqui do CAPS?" }, { id: 6, adaptada: "Pensou que, mesmo na dificuldade, Deus pode estar te fortalecendo?" }, { id: 7, adaptada: "Você pediu perdão a Deus por algo do seu passado?" }, { id: 8, adaptada: "Já teve a sensação de que Deus te deixou de lado?" }, { id: 9, adaptada: "Sentiu dúvida se Deus realmente se importa contigo?" }, { id: 10, adaptada: "Pensou que o vício ou as recaídas são um castigo de Deus?" }, { id: 11, adaptada: "Já sentiu raiva de Deus pelo que está passando?" }, { id: 12, adaptada: "Acreditou que tudo que passou é uma punição de Deus?" }, { id: 13, adaptada: "Sentiu que Deus estava te testando com as dificuldades?" }, { id: 14, adaptada: "Ficou difícil confiar em Deus em certos momentos?" }, ] },
            };
            const responseOptions = ["Nunca", "Raramente", "Às vezes", "Muitas vezes", "Sempre"];
            const responseMap = { "Nunca": 1, "Raramente": 2, "Às vezes": 3, "Muitas vezes": 4, "Sempre": 5 };

            const trainingData = [
                {
                    title: "Passo 1 de 5: Introdução e Ética",
                    content: "Seu trabalho é a ponte entre a universidade e a comunidade. Estamos lidando com temas profundos e pessoais. Sua postura deve ser sempre de acolhimento, respeito e total confidencialidade.",
                    question: "Qual é a postura correta do extensionista?",
                    options: ["Julgar as respostas para ajudar", "Apressar o participante para otimizar o tempo", "Acolhimento, respeito e confidencialidade"],
                    correctAnswer: "Acolhimento, respeito e confidencialidade"
                },
                {
                    title: "Passo 2 de 5: A Abordagem Correta",
                    content: "Antes de iniciar as perguntas, é fundamental estabelecer uma conexão de confiança. Apresente-se, explique o objetivo do projeto de forma simples, peça permissão para continuar (consentimento) e garanta a confidencialidade das respostas.",
                    question: "O que você deve fazer antes de iniciar as perguntas da escala?",
                    options: ["Começar imediatamente para não perder tempo", "Apresentar-se, explicar o projeto e pedir consentimento", "Apenas dizer seu nome e iniciar a escala"],
                    correctAnswer: "Apresentar-se, explicar o projeto e pedir consentimento"
                },
                {
                    title: "Passo 3 de 5: Uso do Aplicativo (Parte 1)",
                    content: "Na primeira vez que usar o aplicativo, você precisará inserir seus dados (nome, matrícula, telefone). O aplicativo salvará essas informações no navegador para que, nos próximos acessos, você pule diretamente para a tela de seleção de projeto.",
                    question: "O que acontece após você preencher seus dados de extensionista pela primeira vez?",
                    options: ["Você precisa preencher tudo de novo a cada uso", "Os dados são salvos no navegador para agilizar acessos futuros", "O aplicativo envia uma confirmação por e-mail"],
                    correctAnswer: "Os dados são salvos no navegador para agilizar acessos futuros"
                },
                {
                    title: "Passo 4 de 5: Uso do Aplicativo (Parte 2)",
                    content: "O fluxo de coleta de dados é: 1) Preencher os dados do participante. 2) Aplicar as 14 perguntas. 3) Clicar em 'Pré-visualizar Mensagem' para revisar todo o relatório antes de enviá-lo.",
                    question: "Qual é a etapa que vem *imediatamente após* preencher as 14 perguntas da escala?",
                    options: ["Abrir o programa de e-mail", "Pré-visualizar a mensagem gerada", "Selecionar o projeto novamente"],
                    correctAnswer: "Pré-visualizar a mensagem gerada"
                },
                {
                    title: "Passo 5 de 5: Finalizando o Envio",
                    content: "Após revisar a mensagem na tela de pré-visualização, você clicará em 'Abrir Programa de E-mail'. O aplicativo de e-mail do seu dispositivo será aberto com tudo já preenchido. Sua única tarefa é conferir uma última vez e clicar no botão 'Enviar' do seu programa de e-mail.",
                    question: "Após clicar em 'Abrir Programa de E-mail', qual é a sua única tarefa?",
                    options: ["Clicar em 'Enviar' no seu próprio programa de e-mail", "Escrever o e-mail do zero com suas palavras", "Anexar um arquivo PDF que foi gerado"],
                    correctAnswer: "Clicar em 'Enviar' no seu próprio programa de e-mail"
                }
            ];

            // --- Estado da Aplicação ---
            let appState = {
                studentName: '',
                studentId: '',
                studentPhone: '',
                projectKey: '',
                mailtoUrl: '',
                trainingStep: 0,
                trainingScore: 0,
            };

            // --- Elementos da DOM ---
            const screens = {
                welcome: document.getElementById('welcome-screen'),
                training: document.getElementById('training-screen'),
                trainingResult: document.getElementById('training-result-screen'),
                studentInfo: document.getElementById('student-info-screen'),
                projectSelection: document.getElementById('project-selection-screen'),
                dataCollection: document.getElementById('data-collection-screen'),
                preview: document.getElementById('preview-screen'),
            };
            const studentForm = document.getElementById('student-form');
            const projectButtonsContainer = document.getElementById('project-buttons-container');
            const dataForm = document.getElementById('data-form');
            const questionsIntro = document.getElementById('questions-intro');
            const questionsList = document.getElementById('questions-list');
            const statusMessage = document.getElementById('status-message');
            const backToStudentInfoBtn = document.getElementById('back-to-student-info');
            const backToProjectSelectionBtn = document.getElementById('back-to-project-selection');
            const previewMessageContainer = document.getElementById('preview-message');
            const sendByEmailBtn = document.getElementById('send-by-email-btn');
            const backToFormBtn = document.getElementById('back-to-form-btn');
            const showTrainingBtn = document.getElementById('show-training-btn');
            const startCollectionBtn = document.getElementById('start-collection-btn');
            const backToWelcomeBtn = document.getElementById('back-to-welcome-btn');
            const trainingStepContent = document.getElementById('training-step-content');
            const trainingQuestionContainer = document.getElementById('training-question-container');
            const trainingFeedback = document.getElementById('training-feedback');
            const nextStepBtn = document.getElementById('next-step-btn');
            const trainingResultScreen = document.getElementById('training-result-screen');
            const trainingScoreEl = document.getElementById('training-score');
            const trainingResultMessageEl = document.getElementById('training-result-message');
            const trainingResultActionsEl = document.getElementById('training-result-actions');
            const trainingStatusEl = document.getElementById('training-status');


            // --- Funções de Navegação ---
            const navigateTo = (screenName) => {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            };

            // --- Lógica do Treinamento ---
            const startTraining = () => {
                appState.trainingStep = 0;
                appState.trainingScore = 0;
                renderTrainingStep(appState.trainingStep);
                navigateTo('training');
            };

            const renderTrainingStep = (stepIndex) => {
                const step = trainingData[stepIndex];
                trainingStepContent.innerHTML = `<h3>${step.title}</h3><p>${step.content}</p>`;
                
                let questionHTML = `<h4 class="font-bold mt-4">${step.question}</h4><div class="space-y-2 mt-2">`;
                step.options.forEach((option, index) => {
                    questionHTML += `
                        <label class="flex items-center space-x-2 text-gray-700 cursor-pointer">
                            <input type="radio" name="training-q" value="${option}" required class="form-radio h-5 w-5">
                            <span>${option}</span>
                        </label>
                    `;
                });
                questionHTML += `</div>`;
                trainingQuestionContainer.innerHTML = questionHTML;
                trainingFeedback.textContent = '';
                nextStepBtn.disabled = false;
            };

            const handleNextStep = () => {
                const selectedOption = document.querySelector('input[name="training-q"]:checked');
                if (!selectedOption) {
                    trainingFeedback.textContent = 'Por favor, selecione uma resposta.';
                    trainingFeedback.className = 'mt-4 font-semibold text-red-600';
                    return;
                }

                nextStepBtn.disabled = true;
                const currentStep = trainingData[appState.trainingStep];
                if (selectedOption.value === currentStep.correctAnswer) {
                    appState.trainingScore++;
                    trainingFeedback.textContent = 'Correto!';
                    trainingFeedback.className = 'mt-4 font-semibold text-green-600';
                } else {
                    trainingFeedback.textContent = `Incorreto. A resposta certa é: "${currentStep.correctAnswer}"`;
                    trainingFeedback.className = 'mt-4 font-semibold text-red-600';
                }

                setTimeout(() => {
                    appState.trainingStep++;
                    if (appState.trainingStep < trainingData.length) {
                        renderTrainingStep(appState.trainingStep);
                    } else {
                        showTrainingResult();
                    }
                }, 1500);
            };
            
            const showTrainingResult = () => {
                const totalQuestions = trainingData.length;
                const score = (appState.trainingScore / totalQuestions) * 100;
                trainingScoreEl.textContent = `${score.toFixed(0)}%`;

                trainingResultActionsEl.innerHTML = '';
                if (score >= 90) {
                    trainingResultMessageEl.textContent = "Parabéns, você foi aprovado e está apto para iniciar a coleta de dados!";
                    trainingResultMessageEl.className = "text-lg font-semibold mb-6 text-green-600";
                    localStorage.setItem('trainingCompleted', 'true');
                    checkTrainingStatus(); // Atualiza o botão na tela inicial
                    const continueBtn = document.createElement('button');
                    continueBtn.textContent = 'Ir para a Coleta';
                    continueBtn.className = 'py-2 px-6 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700';
                    continueBtn.onclick = () => checkStudentData();
                    trainingResultActionsEl.appendChild(continueBtn);
                } else {
                    trainingResultMessageEl.textContent = "Você não atingiu a pontuação mínima de 90%. Por favor, estude o manual e tente novamente.";
                    trainingResultMessageEl.className = "text-lg font-semibold mb-6 text-red-600";
                    const retryBtn = document.createElement('button');
                    retryBtn.textContent = 'Tentar Novamente';
                    retryBtn.className = 'py-2 px-6 text-white font-semibold bg-gray-500 rounded-md hover:bg-gray-600';
                    retryBtn.onclick = startTraining;
                    trainingResultActionsEl.appendChild(retryBtn);
                }
                navigateTo('trainingResult');
            };

            // --- Renderização e Lógica da UI (Coleta) ---
            
            Object.keys(projectConfig).forEach(key => {
                const project = projectConfig[key];
                const button = document.createElement('button');
                button.dataset.projectKey = key;
                button.className = `p-8 rounded-lg text-white font-bold text-lg shadow-lg transform transition hover:scale-105 bg-${project.color}-600`;
                button.textContent = project.name;
                button.addEventListener('click', () => {
                    appState.projectKey = key;
                    renderDataCollectionScreen(key);
                    navigateTo('dataCollection');
                });
                projectButtonsContainer.appendChild(button);
            });

            const renderDataCollectionScreen = (projectKey) => {
                const project = projectConfig[projectKey];
                questionsIntro.textContent = `Instrução: ${project.intro}`;
                questionsIntro.className = `p-4 rounded-md italic ${project.bgColor} ${project.textColor}`;
                
                questionsList.innerHTML = '';
                project.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'p-4 border border-gray-200 rounded-lg';
                    
                    const questionP = document.createElement('p');
                    questionP.className = 'font-semibold text-gray-800';
                    questionP.textContent = `${index + 1}. ${q.adaptada}`;
                    questionDiv.appendChild(questionP);

                    const radioContainer = document.createElement('div');
                    radioContainer.className = 'flex flex-wrap gap-x-4 gap-y-2 mt-3';

                    responseOptions.forEach((opt) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 text-gray-700 cursor-pointer';
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `question-${index}`;
                        radio.value = opt;
                        radio.required = true;
                        radio.className = `form-radio h-5 w-5 text-${project.color}-600`;
                        const span = document.createElement('span');
                        span.textContent = opt;
                        label.appendChild(radio);
                        label.appendChild(span);
                        radioContainer.appendChild(label);
                    });
                    questionDiv.appendChild(radioContainer);
                    questionsList.appendChild(questionDiv);
                });
            };

            // --- Lógica de Geração da Mensagem ---
            const getInterpretation = (score, type) => {
                if (type === 'positive') {
                    if (score <= 14) return "Muito baixo – espiritualidade pouco utilizada como recurso";
                    if (score <= 24) return "Moderado – espiritualidade usada de forma ocasional";
                    return "Alto – uso frequente e ativo da espiritualidade como coping";
                }
                if (type === 'negative') {
                    if (score <= 14) return "Muito baixo – poucos sentimentos negativos em relação à fé";
                    if (score <= 24) return "Moderado – ambivalência espiritual (dúvidas, conflitos)";
                    return "Alto – espiritualidade associada a sofrimento, culpa ou abandono";
                }
                return "";
            };

            const generatePreview = (formData) => {
                statusMessage.textContent = '';
                try {
                    const project = projectConfig[formData.projectKey];
                    
                    const numericResponses = formData.responses.map(r => responseMap[r] || 0);
                    const positiveScore = numericResponses.slice(0, 7).reduce((a, b) => a + b, 0);
                    const negativeScore = numericResponses.slice(7, 14).reduce((a, b) => a + b, 0);

                    const positiveInterpretation = getInterpretation(positiveScore, 'positive');
                    const negativeInterpretation = getInterpretation(negativeScore, 'negative');

                    let emailBody = `UNIVERSIDADE FEDERAL DE CAMPINA GRANDE\n`;
                    emailBody += `CENTRO DE FORMAÇÃO DE PROFESSORES\n`;
                    emailBody += `UNIDADE ACADÊMICA DE ENFERMAGEM\n`;
                    emailBody += `*PROGRAMA DE EXTENSÃO ESPIRITUALIDADE E SAÚDE MENTAL*\n\n`;
                    emailBody += `------------------------------------\n\n`;
                    emailBody += `*RELATÓRIO DE AVALIAÇÃO - CER-BREVE-14*\n\n`;
                    emailBody += `*Projeto:* ${project.name}\n`;
                    emailBody += `*Data:* ${new Date().toLocaleString('pt-BR')}\n\n`;
                    emailBody += `*Dados do Extensionista:*\n`;
                    emailBody += `Nome: ${formData.studentName}\n`;
                    emailBody += `Matrícula: ${formData.studentId}\n`;
                    emailBody += `Contato: ${formData.studentPhone}\n\n`;
                    emailBody += `*Dados do Participante:*\n`;
                    emailBody += `Nome: ${formData.participantName}\n`;
                    emailBody += `Idade: ${formData.participantAge}\n`;
                    emailBody += `Sexo: ${formData.participantSex}\n\n`;
                    emailBody += `*Resultados da Escala:*\n`;
                    emailBody += `CER Positivo (Itens 1-7): *${positiveScore}*\n`;
                    emailBody += `CER Negativo (Itens 8-14): *${negativeScore}*\n\n`;
                    emailBody += `*Perfil Espiritual (Interpretação):*\n`;
                    emailBody += `Coping Positivo: *${positiveInterpretation}*\n`;
                    emailBody += `Coping Negativo: *${negativeInterpretation}*\n\n`;
                    emailBody += `*Respostas Detalhadas:*\n`;
                    project.questions.forEach((q, index) => {
                        emailBody += `${index + 1}. ${q.adaptada}\n`;
                        emailBody += `   - Resposta: *${formData.responses[index]}*\n`;
                    });

                    previewMessageContainer.innerText = emailBody;
                    
                    const recipient = "probex2025.espiritualidade@gmail.com";
                    const subject = `Relatório do Projeto: ${project.name}`;
                    appState.mailtoUrl = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                    
                    navigateTo('preview');

                } catch (err) {
                    console.error("Preview Error:", err);
                    statusMessage.textContent = 'Houve um erro ao preparar a mensagem. Tente novamente.';
                    statusMessage.className = 'mb-4 font-semibold text-red-600';
                }
            };

            const checkStudentData = () => {
                const savedName = localStorage.getItem('studentName');
                const savedId = localStorage.getItem('studentId');
                const savedPhone = localStorage.getItem('studentPhone');

                if (savedName && savedId && savedPhone) {
                    appState.studentName = savedName;
                    appState.studentId = savedId;
                    appState.studentPhone = savedPhone;
                    
                    document.getElementById('student-name').value = savedName;
                    document.getElementById('student-id').value = savedId;
                    document.getElementById('student-phone').value = savedPhone;
                    navigateTo('projectSelection');
                } else {
                    navigateTo('studentInfo');
                }
            };

            // --- Event Listeners ---
            showTrainingBtn.addEventListener('click', startTraining);
            backToWelcomeBtn.addEventListener('click', () => navigateTo('welcome'));
            nextStepBtn.addEventListener('click', handleNextStep);

            startCollectionBtn.addEventListener('click', checkStudentData);

            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appState.studentName = document.getElementById('student-name').value;
                appState.studentId = document.getElementById('student-id').value;
                appState.studentPhone = document.getElementById('student-phone').value;
                
                localStorage.setItem('studentName', appState.studentName);
                localStorage.setItem('studentId', appState.studentId);
                localStorage.setItem('studentPhone', appState.studentPhone);

                navigateTo('projectSelection');
            });

            backToStudentInfoBtn.addEventListener('click', () => {
                localStorage.removeItem('studentName');
                localStorage.removeItem('studentId');
                localStorage.removeItem('studentPhone');
                navigateTo('studentInfo');
            });
            
            backToProjectSelectionBtn.addEventListener('click', () => navigateTo('projectSelection'));
            
            backToFormBtn.addEventListener('click', () => navigateTo('dataCollection'));

            sendByEmailBtn.addEventListener('click', () => {
                if (appState.mailtoUrl) {
                    dataForm.reset();
                    navigateTo('projectSelection');
                    window.location.href = appState.mailtoUrl;
                }
            });

            dataForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const participantData = {
                    participantName: document.getElementById('participant-name').value,
                    participantAge: document.getElementById('participant-age').value,
                    participantSex: document.getElementById('participant-sex').value,
                    responses: []
                };

                const project = projectConfig[appState.projectKey];
                for (let i = 0; i < project.questions.length; i++) {
                    const response = document.querySelector(`input[name="question-${i}"]:checked`);
                    if (response) {
                        participantData.responses.push(response.value);
                    } else {
                        statusMessage.textContent = `Por favor, responda a pergunta ${i + 1}.`;
                        statusMessage.className = 'mb-4 font-semibold text-red-600';
                        setTimeout(() => { statusMessage.textContent = ''; }, 3000);
                        return;
                    }
                }
                
                const fullData = { ...appState, ...participantData };
                generatePreview(fullData);
            });

            // --- Inicialização ---
            const checkTrainingStatus = () => {
                const isCompleted = localStorage.getItem('trainingCompleted') === 'true';
                if (isCompleted) {
                    startCollectionBtn.disabled = false;
                    startCollectionBtn.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                    trainingStatusEl.textContent = 'Treinamento concluído! Você já pode iniciar a coleta.';
                    trainingStatusEl.className = 'text-center mt-4 text-sm text-green-600';
                } else {
                    startCollectionBtn.disabled = true;
                     trainingStatusEl.textContent = 'É necessário completar o treinamento para liberar a coleta.';
                     trainingStatusEl.className = 'text-center mt-4 text-sm text-red-600';
                }
            };

            const initApp = () => {
                 document.getElementById('loading-screen').classList.add('hidden');
                 document.getElementById('app-container').classList.remove('hidden');
                 checkTrainingStatus();
                 navigateTo('welcome');
            };

            initApp();
        });
    </script>
</body>
</html>
