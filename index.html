<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relatório - CER-Breve-14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-screen" class="min-h-screen flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="text-lg font-medium mt-4">Carregando Aplicação...</p>
    </div>

    <div id="app-container" class="p-4 sm:p-8 hidden">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
            
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 text-center">Gerador de Relatório</h1>
                <p class="text-center text-gray-600 mt-2">Escala de Coping Religioso-Espiritual (CER-Breve-14)</p>
            </div>

            <!-- Tela 1: Informações do Aluno -->
            <div id="student-info-screen">
                <form id="student-form" class="space-y-6">
                    <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">1. Identificação do Extensionista</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Seu Nome Completo</label>
                            <input type="text" id="student-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Sua Matrícula</label>
                            <input type="text" id="student-id" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Seu Telefone / WhatsApp</label>
                            <input type="tel" id="student-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                    </div>
                    <div class="text-center pt-4">
                         <button type="submit" class="w-full md:w-1/2 py-2 px-4 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700">Próximo</button>
                    </div>
                </form>
            </div>

            <!-- Tela 2: Seleção de Projeto -->
            <div id="project-selection-screen" class="hidden">
                 <h3 class="text-xl font-semibold mb-6 pb-2 border-b-2 border-gray-400 text-gray-700 text-center">2. Selecione o Projeto</h3>
                 <div id="project-buttons-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Botões serão inseridos aqui -->
                 </div>
                 <div class="text-center mt-8">
                    <button id="back-to-student-info" class="text-sm text-gray-600 hover:text-gray-800">&larr; Alterar dados do Extensionista</button>
                 </div>
            </div>

            <!-- Tela 3: Coleta de Dados do Público Alvo -->
            <div id="data-collection-screen" class="hidden">
                <form id="data-form" class="space-y-8">
                    <!-- Dados do Participante -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">3. Informações do Participante</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome do Participante</label>
                                <input type="text" id="participant-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Idade do Participante</label>
                                <input type="number" id="participant-age" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Sexo do Participante</label>
                                <select id="participant-sex" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white">
                                    <option value="">Selecione...</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Seção da Escala -->
                    <div id="questions-container">
                        <h3 id="questions-title" class="text-xl font-semibold mb-2">4. Escala CER-Breve-14</h3>
                        <p id="questions-intro" class="p-4 rounded-md italic">
                            <!-- Instrução inserida pelo JS -->
                        </p>
                        <div id="questions-list" class="space-y-6 mt-6">
                            <!-- Perguntas inseridas pelo JS -->
                        </div>
                    </div>

                    <!-- Seção de Submissão -->
                    <div class="text-center pt-4">
                        <div id="status-message" class="mb-4 font-semibold"></div>
                        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                             <button type="button" id="back-to-project-selection" class="text-sm text-gray-600 hover:text-gray-800 order-2 sm:order-1">&larr; Voltar para Seleção de Projeto</button>
                            <button type="submit" id="submit-button" class="w-full md:w-2/3 py-3 px-6 text-white font-bold text-lg rounded-lg shadow-md transition bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 order-1 sm:order-2">
                                Enviar Dados via WhatsApp
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuração dos Projetos e Perguntas ---
            const projectConfig = {
              idosos: { name: "Idosos Institucionalizados (Abrigo Lucas Zorn)", whatsapp: "5584994420139", color: "green", bgColor: "bg-green-50", textColor: "text-green-800", buttonColor: "bg-green-600", intro: "Vou te fazer umas perguntas bem simples sobre sua fé ou sua ligação com Deus, tá certo? Não tem resposta certa ou errada, é só o que você sente, tá bom?", questions: [ { id: 1, adaptada: "O(a) senhor(a) sentiu vontade de se aproximar mais de Deus, conversar mais com Ele nesses últimos tempos?" }, { id: 2, adaptada: "Teve momentos que o(a) senhor(a) sentiu que precisava do carinho ou da proteção de Deus?" }, { id: 3, adaptada: "Rezou ou conversou com Deus pedindo ajuda, conforto ou um conselho sobre o que fazer?" }, { id: 4, adaptada: "O(a) senhor(a) procurou se fortalecer em Deus quando as coisas estavam difíceis?" }, { id: 5, adaptada: "O(a) senhor(a) costuma rezar por outras pessoas, como amigos, família, colegas daqui do abrigo?" }, { id: 6, adaptada: "O(a) senhor(a) chegou a pensar que essa situação pode estar servindo pra te tornar mais forte com a ajuda de Deus?" }, { id: 7, adaptada: "Sentiu vontade de conversar com Deus pra pedir perdão por algo que acredita que fez de errado?" }, { id: 8, adaptada: "Teve algum momento que sentiu como se Deus tivesse te deixado sozinho(a)?" }, { id: 9, adaptada: "Já pensou se Deus realmente te ama ou se te esqueceu?" }, { id: 10, adaptada: "Já sentiu que Deus tá te castigando por algo?" }, { id: 11, adaptada: "Já ficou com raiva de Deus por tudo que tá passando?" }, { id: 12, adaptada: "Pensou que tudo isso que está vivendo pode ser um castigo de Deus?" }, { id: 13, adaptada: "Acredita que Deus está te provando ou testando com essa situação?" }, { id: 14, adaptada: "Teve dias em que ficou difícil acreditar ou confiar em Deus?" }, ] },
              cuidadores: { name: "Cuidadores de CRIANES (APAE)", whatsapp: "5583999992617", color: "pink", bgColor: "bg-pink-50", textColor: "text-pink-800", buttonColor: "bg-pink-600", intro: "A gente quer entender como a fé ajuda (ou não ajuda) no seu dia a dia com a criança. Pode responder como se estivesse contando sua rotina pra um amigo, tudo certo?", questions: [ { id: 1, adaptada: "Você buscou se aproximar mais de Deus nos momentos difíceis com seu filho(a)?" }, { id: 2, adaptada: "Sentiu que precisava da proteção de Deus diante dos desafios de cuidar da criança?" }, { id: 3, adaptada: "Você rezou ou meditou pedindo orientação ou consolo em situações difíceis?" }, { id: 4, adaptada: "Buscou forças em Deus para continuar lutando pelo cuidado da criança?" }, { id: 5, adaptada: "Você costuma rezar por outras pessoas, como por seu(sua) filho(a), familiares ou amigos?" }, { id: 6, adaptada: "Já pensou que Deus pode estar te dando força para enfrentar tudo isso?" }, { id: 7, adaptada: "Você pediu perdão a Deus por algo que acha que poderia ter feito diferente?" }, { id: 8, adaptada: "Sentiu que Deus te deixou sozinha(o) nesse cuidado todo?" }, { id: 9, adaptada: "Já teve dúvida se Deus te ama mesmo diante de tanto sofrimento?" }, { id: 10, adaptada: "Você pensou que tudo isso pode ser um castigo de Deus?" }, { id: 11, adaptada: "Já ficou com raiva de Deus por tudo que está vivendo?" }, { id: 12, adaptada: "Acreditou que os problemas são um castigo?" }, { id: 13, adaptada: "Você sentiu que tudo isso é um teste de Deus pra você?" }, { id: 14, adaptada: "Teve dificuldade em acreditar ou confiar em Deus durante esse processo?" }, ] },
              dependentes: { name: "Usuários do CAPS AD (Dependentes Químicos)", whatsapp: "5583991007459", color: "orange", bgColor: "bg-orange-50", textColor: "text-orange-800", buttonColor: "bg-orange-600", intro: "A gente quer saber como a sua fé ou sua relação com Deus tem influenciado no seu tratamento. Pode responder com sinceridade, sem julgamento.", questions: [ { id: 1, adaptada: "Você tentou se aproximar mais de Deus nesse tempo de tratamento?" }, { id: 2, adaptada: "Buscou proteção e carinho de Deus nas horas difíceis?" }, { id: 3, adaptada: "Você orou, meditou ou conversou com Deus pedindo ajuda ou clareza?" }, { id: 4, adaptada: "Sentiu que precisava buscar forças em Deus pra vencer as recaídas ou a abstinência?" }, { id: 5, adaptada: "Você rezou por outras pessoas, como amigos, família ou colegas daqui do CAPS?" }, { id: 6, adaptada: "Pensou que, mesmo na dificuldade, Deus pode estar te fortalecendo?" }, { id: 7, adaptada: "Você pediu perdão a Deus por algo do seu passado?" }, { id: 8, adaptada: "Já teve a sensação de que Deus te deixou de lado?" }, { id: 9, adaptada: "Sentiu dúvida se Deus realmente se importa contigo?" }, { id: 10, adaptada: "Pensou que o vício ou as recaídas são um castigo de Deus?" }, { id: 11, adaptada: "Já sentiu raiva de Deus pelo que está passando?" }, { id: 12, adaptada: "Acreditou que tudo que passou é uma punição de Deus?" }, { id: 13, adaptada: "Sentiu que Deus estava te testando com as dificuldades?" }, { id: 14, adaptada: "Ficou difícil confiar em Deus em certos momentos?" }, ] },
            };
            const responseOptions = ["Nunca", "Raramente", "Às vezes", "Muitas vezes", "Sempre"];
            const responseMap = { "Nunca": 1, "Raramente": 2, "Às vezes": 3, "Muitas vezes": 4, "Sempre": 5 };

            // --- Estado da Aplicação ---
            let appState = {
                studentName: '',
                studentId: '',
                studentPhone: '',
                projectKey: '',
            };

            // --- Elementos da DOM ---
            const screens = {
                studentInfo: document.getElementById('student-info-screen'),
                projectSelection: document.getElementById('project-selection-screen'),
                dataCollection: document.getElementById('data-collection-screen'),
            };
            const studentForm = document.getElementById('student-form');
            const projectButtonsContainer = document.getElementById('project-buttons-container');
            const dataForm = document.getElementById('data-form');
            const questionsIntro = document.getElementById('questions-intro');
            const questionsList = document.getElementById('questions-list');
            const statusMessage = document.getElementById('status-message');
            const submitButton = document.getElementById('submit-button');
            const backToStudentInfoBtn = document.getElementById('back-to-student-info');
            const backToProjectSelectionBtn = document.getElementById('back-to-project-selection');

            // --- Funções de Navegação ---
            const navigateTo = (screenName) => {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            };

            // --- Renderização e Lógica da UI ---
            
            Object.keys(projectConfig).forEach(key => {
                const project = projectConfig[key];
                const button = document.createElement('button');
                button.dataset.projectKey = key;
                button.className = `p-8 rounded-lg text-white font-bold text-lg shadow-lg transform transition hover:scale-105 bg-${project.color}-600`;
                button.textContent = project.name;
                button.addEventListener('click', () => {
                    appState.projectKey = key;
                    renderDataCollectionScreen(key);
                    navigateTo('dataCollection');
                });
                projectButtonsContainer.appendChild(button);
            });

            const renderDataCollectionScreen = (projectKey) => {
                const project = projectConfig[projectKey];
                questionsIntro.textContent = `Instrução: ${project.intro}`;
                questionsIntro.className = `p-4 rounded-md italic ${project.bgColor} ${project.textColor}`;
                
                questionsList.innerHTML = '';
                project.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'p-4 border border-gray-200 rounded-lg';
                    
                    const questionP = document.createElement('p');
                    questionP.className = 'font-semibold text-gray-800';
                    questionP.textContent = `${index + 1}. ${q.adaptada}`;
                    questionDiv.appendChild(questionP);

                    const radioContainer = document.createElement('div');
                    radioContainer.className = 'flex flex-wrap gap-x-4 gap-y-2 mt-3';

                    responseOptions.forEach((opt) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 text-gray-700 cursor-pointer';
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `question-${index}`;
                        radio.value = opt;
                        radio.required = true;
                        radio.className = `form-radio h-5 w-5 text-${project.color}-600`;
                        const span = document.createElement('span');
                        span.textContent = opt;
                        label.appendChild(radio);
                        label.appendChild(span);
                        radioContainer.appendChild(label);
                    });
                    questionDiv.appendChild(radioContainer);
                    questionsList.appendChild(questionDiv);
                });
            };

            // --- Lógica de Geração da Mensagem ---
            const getInterpretation = (score, type) => {
                if (type === 'positive') {
                    if (score <= 14) return "Muito baixo – espiritualidade pouco utilizada como recurso";
                    if (score <= 24) return "Moderado – espiritualidade usada de forma ocasional";
                    return "Alto – uso frequente e ativo da espiritualidade como coping";
                }
                if (type === 'negative') {
                    if (score <= 14) return "Muito baixo – poucos sentimentos negativos em relação à fé";
                    if (score <= 24) return "Moderado – ambivalência espiritual (dúvidas, conflitos)";
                    return "Alto – espiritualidade associada a sofrimento, culpa ou abandono";
                }
                return "";
            };

            const formatAndShareMessage = (formData) => {
                statusMessage.textContent = 'Preparando mensagem para o WhatsApp...';
                statusMessage.className = 'mb-4 font-semibold text-blue-600';
                submitButton.disabled = true;

                try {
                    const project = projectConfig[formData.projectKey];
                    
                    const numericResponses = formData.responses.map(r => responseMap[r] || 0);
                    const positiveScore = numericResponses.slice(0, 7).reduce((a, b) => a + b, 0);
                    const negativeScore = numericResponses.slice(7, 14).reduce((a, b) => a + b, 0);

                    const positiveInterpretation = getInterpretation(positiveScore, 'positive');
                    const negativeInterpretation = getInterpretation(negativeScore, 'negative');

                    let message = `*Relatório de Avaliação - CER-Breve-14*\n\n`;
                    message += `*Projeto:* ${project.name}\n`;
                    message += `*Data:* ${new Date().toLocaleString('pt-BR')}\n\n`;

                    message += `*Dados do Extensionista:*\n`;
                    message += `Nome: ${formData.studentName}\n`;
                    message += `Matrícula: ${formData.studentId}\n`;
                    message += `Contato: ${formData.studentPhone}\n\n`;

                    message += `*Dados do Participante:*\n`;
                    message += `Nome: ${formData.participantName}\n`;
                    message += `Idade: ${formData.participantAge}\n`;
                    message += `Sexo: ${formData.participantSex}\n\n`;

                    message += `*Resultados da Escala:*\n`;
                    message += `CER Positivo (Itens 1-7): *${positiveScore}*\n`;
                    message += `CER Negativo (Itens 8-14): *${negativeScore}*\n\n`;

                    message += `*Perfil Espiritual (Interpretação):*\n`;
                    message += `Coping Positivo: *${positiveInterpretation}*\n`;
                    message += `Coping Negativo: *${negativeInterpretation}*\n\n`;

                    message += `*Respostas Detalhadas:*\n`;
                    project.questions.forEach((q, index) => {
                        message += `${index + 1}. ${q.adaptada}\n`;
                        message += `   - Resposta: *${formData.responses[index]}*\n`;
                    });

                    statusMessage.textContent = 'Abrindo WhatsApp...';
                    statusMessage.className = 'mb-4 font-semibold text-green-600';

                    const professorWhatsapp = project.whatsapp;
                    const whatsappUrl = `https://wa.me/${professorWhatsapp}?text=${encodeURIComponent(message)}`;
                    
                    window.open(whatsappUrl, '_blank');
                    
                    dataForm.reset();
                    // Não reseta o formulário do aluno, pois os dados estão salvos
                    navigateTo('projectSelection');

                } catch (err) {
                    console.error("WhatsApp Error:", err);
                    statusMessage.textContent = 'Houve um erro ao preparar a mensagem. Tente novamente.';
                    statusMessage.className = 'mb-4 font-semibold text-red-600';
                } finally {
                    submitButton.disabled = false;
                    setTimeout(() => { statusMessage.textContent = ''; }, 10000);
                }
            };

            // --- Event Listeners ---
            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appState.studentName = document.getElementById('student-name').value;
                appState.studentId = document.getElementById('student-id').value;
                appState.studentPhone = document.getElementById('student-phone').value;
                
                // Salva os dados no localStorage
                localStorage.setItem('studentName', appState.studentName);
                localStorage.setItem('studentId', appState.studentId);
                localStorage.setItem('studentPhone', appState.studentPhone);

                navigateTo('projectSelection');
            });

            backToStudentInfoBtn.addEventListener('click', () => {
                // Limpa os dados salvos para permitir a alteração
                localStorage.removeItem('studentName');
                localStorage.removeItem('studentId');
                localStorage.removeItem('studentPhone');
                navigateTo('studentInfo');
            });
            
            backToProjectSelectionBtn.addEventListener('click', () => navigateTo('projectSelection'));

            dataForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const participantData = {
                    participantName: document.getElementById('participant-name').value,
                    participantAge: document.getElementById('participant-age').value,
                    participantSex: document.getElementById('participant-sex').value,
                    responses: []
                };

                const project = projectConfig[appState.projectKey];
                for (let i = 0; i < project.questions.length; i++) {
                    const response = document.querySelector(`input[name="question-${i}"]:checked`);
                    if (response) {
                        participantData.responses.push(response.value);
                    } else {
                        statusMessage.textContent = `Por favor, responda a pergunta ${i + 1}.`;
                        statusMessage.className = 'mb-4 font-semibold text-red-600';
                        return;
                    }
                }
                
                const fullData = { ...appState, ...participantData };
                formatAndShareMessage(fullData);
            });

            // --- Inicialização ---
            const checkSavedData = () => {
                const savedName = localStorage.getItem('studentName');
                const savedId = localStorage.getItem('studentId');
                const savedPhone = localStorage.getItem('studentPhone');

                if (savedName && savedId && savedPhone) {
                    appState.studentName = savedName;
                    appState.studentId = savedId;
                    appState.studentPhone = savedPhone;
                    // Preenche o formulário caso o usuário volte
                    document.getElementById('student-name').value = savedName;
                    document.getElementById('student-id').value = savedId;
                    document.getElementById('student-phone').value = savedPhone;
                    navigateTo('projectSelection');
                } else {
                    navigateTo('studentInfo');
                }
                 document.getElementById('loading-screen').classList.add('hidden');
                 document.getElementById('app-container').classList.remove('hidden');
            };

            checkSavedData();
        });
    </script>
</body>
</html>
