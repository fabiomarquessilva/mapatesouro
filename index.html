<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relatório - CER-Breve-14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .email-preview, .manual-content {
            white-space: pre-wrap; /* Mantém as quebras de linha e espaços */
            word-wrap: break-word; /* Quebra palavras longas */
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            color: #333;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
        }
        .manual-content h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #ccc;
            padding-bottom: 0.5rem;
        }
        .manual-content h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
         .manual-content h4 {
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .manual-content ul {
            list-style-type: disc;
            margin-left: 2rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-screen" class="min-h-screen flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="text-lg font-medium mt-4">Carregando Aplicação...</p>
    </div>

    <div id="app-container" class="p-4 sm:p-8 hidden">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
            
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 text-center">Gerador de Relatório</h1>
                <p class="text-center text-gray-600 mt-2">Escala de Coping Religioso-Espiritual (CER-Breve-14)</p>
            </div>

            <!-- Tela 0: Boas-vindas -->
            <div id="welcome-screen">
                <h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">Bem-vindo, Extensionista!</h2>
                <p class="text-center text-gray-600 mb-8">Escolha uma opção para começar.</p>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                    <button id="show-manual-btn" class="w-full sm:w-1/2 py-3 px-6 text-white font-semibold bg-gray-500 rounded-md hover:bg-gray-600">Ler o Manual de Aplicação</button>
                    <button id="start-collection-btn" class="w-full sm:w-1/2 py-3 px-6 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700">Iniciar Coleta de Dados</button>
                </div>
            </div>
            
            <!-- Tela do Manual -->
            <div id="manual-screen" class="hidden">
                 <div class="manual-content">
                    <h2>Manual de Aplicação: Escala CER-Breve-14 e Ferramenta Digital</h2>
                    <h3>Para o Extensionista do Programa "Espiritualidade e Saúde Mental"</h3>
                    
                    <h3>1. Introdução</h3>
                    <p>Olá, extensionista!</p>
                    <p>Este manual é o seu guia para a aplicação da Escala de Coping Religioso-Espiritual (CER-Breve-14) junto aos públicos dos nossos projetos. Seu trabalho é a ponte entre a universidade e a comunidade, e a qualidade dos dados que coletamos depende da sua sensibilidade e dedicação.</p>
                    <p>O objetivo desta ferramenta é duplo:</p>
                    <ul>
                        <li>Padronizar a coleta de dados de forma organizada.</li>
                        <li>Facilitar o envio dos relatórios para a coordenação do projeto.</li>
                    </ul>
                    <p>Lembre-se: estamos lidando com temas profundos e pessoais. Sua postura deve ser sempre de acolhimento, respeito e total confidencialidade.</p>

                    <h3>2. Antes de Começar: A Importância da Abordagem Empática</h3>
                    <p>Antes de abrir o aplicativo, sua prioridade é estabelecer uma conexão de confiança com o participante.</p>
                    <ul>
                        <li><strong>Crie um Ambiente Seguro:</strong> Encontre um local tranquilo e privado onde o participante se sinta à vontade para conversar.</li>
                        <li><strong>Apresente-se e o Projeto:</strong> Explique de forma simples quem você é e qual o objetivo da pesquisa: "Estamos tentando entender como a fé e a espiritualidade ajudam as pessoas a lidar com os desafios do dia a dia".</li>
                        <li><strong>Peça Permissão (Consentimento):</strong> Deixe claro que a participação é voluntária e que a pessoa pode parar a qualquer momento. Pergunte: "O(a) senhor(a) gostaria de participar? Leva cerca de 10 minutos".</li>
                        <li><strong>Garanta a Confidencialidade:</strong> Assegure ao participante que suas respostas são confidenciais e que seu nome será usado apenas para a organização interna da pesquisa.</li>
                        <li><strong>Use as Perguntas Adaptadas:</strong> O aplicativo já contém as perguntas em uma linguagem adaptada para cada público. Use-as! Elas foram criadas para serem mais claras e empáticas.</li>
                        <li><strong>Não Julgue as Respostas:</strong> Mantenha uma postura neutra. Não existe resposta "certa" ou "errada". O objetivo é entender o que a pessoa <em>sente</em>.</li>
                    </ul>

                    <h3>3. Guia Prático: Usando o Aplicativo Gerador de Relatório</h3>
                    <p>O aplicativo é um único arquivo HTML. Ele não precisa de instalação e funciona em qualquer navegador de celular, tablet ou computador.</p>
                    <h4>Passo 1: Identificação do Extensionista (Apenas no primeiro uso)</h4>
                    <p>Ao abrir o aplicativo pela primeira vez, você verá uma tela para inserir seus dados:</p>
                    <ul>
                        <li>Nome Completo</li>
                        <li>Matrícula</li>
                        <li>Telefone</li>
                    </ul>
                    <p><strong>Importante:</strong> Esses dados são salvos no navegador para que você não precise digitá-los toda vez. Nos próximos acessos, você irá pular diretamente para a tela de seleção de projeto.</p>
                    
                    <h4>Passo 2: Seleção do Projeto</h4>
                    <p>Nesta tela, você verá 3 botões coloridos:</p>
                    <ul>
                        <li><strong>Verde:</strong> Projeto com Idosos (Abrigo Lucas Zorn)</li>
                        <li><strong>Rosa:</strong> Projeto com Cuidadores de Crianças (APAE)</li>
                        <li><strong>Laranja:</strong> Projeto com Dependentes Químicos (CAPS AD)</li>
                    </ul>
                    <p>Clique no botão correspondente ao público que você está entrevistando. Sua escolha define para qual coordenador o relatório será endereçado e qual a versão adaptada das perguntas será usada.</p>
                    <p><em>Precisa corrigir seus dados?</em> Nesta tela, há um botão "Alterar dados do Extensionista" para voltar à tela inicial e corrigir suas informações.</p>
                    
                    <h4>Passo 3: Coleta de Dados</h4>
                    <p>Esta é a tela principal do formulário.</p>
                    <ol style="list-style-type: decimal; margin-left: 2rem;">
                        <li><strong>Preencha as Informações do Participante:</strong> Nome, idade e sexo da pessoa que está sendo entrevistada.</li>
                        <li><strong>Aplique a Escala:</strong> Leia em voz alta, de forma clara e pausada, cada uma das 14 perguntas que aparecem. Conforme o participante responde, marque a opção correspondente: "Nunca", "Raramente", "Às vezes", "Muitas vezes" ou "Sempre".</li>
                    </ol>
                    
                    <h4>Passo 4: Pré-visualização e Envio do Relatório</h4>
                    <ol style="list-style-type: decimal; margin-left: 2rem;">
                        <li>Após preencher todas as 14 perguntas, clique no botão azul <strong>"Pré-visualizar Mensagem"</strong>.</li>
                        <li>Você será levado a uma nova tela que mostra o <strong>relatório completo</strong> como ele será enviado, incluindo o cabeçalho, os dados que você coletou, os resultados calculados da escala e a interpretação.</li>
                        <li><strong>Revise com atenção!</strong> Verifique se todas as informações estão corretas.</li>
                        <li>Se estiver tudo certo, clique no botão verde <strong>"Abrir Programa de E-mail"</strong>.</li>
                        <li>O aplicativo de e-mail do seu celular ou computador será aberto com uma nova mensagem. O destinatário, o assunto e todo o relatório já estarão preenchidos.</li>
                        <li>Sua única tarefa é <strong>clicar no botão "Enviar"</strong> do seu programa de e-mail.</li>
                    </ol>
                    <p>Pronto! Após o envio, o aplicativo retornará para a tela de seleção de projeto, pronto para uma nova coleta.</p>
                </div>
                <div class="text-center mt-8">
                    <button id="back-to-welcome-btn" class="w-full md:w-1/2 py-2 px-4 text-white font-semibold bg-gray-500 rounded-md hover:bg-gray-600">&larr; Voltar para a Tela Inicial</button>
                </div>
            </div>

            <!-- Tela 1: Informações do Aluno -->
            <div id="student-info-screen" class="hidden">
                <form id="student-form" class="space-y-6">
                    <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">1. Identificação do Extensionista</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Seu Nome Completo</label>
                            <input type="text" id="student-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Sua Matrícula</label>
                            <input type="text" id="student-id" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Seu Telefone / WhatsApp</label>
                            <input type="tel" id="student-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                        </div>
                    </div>
                    <div class="text-center pt-4">
                         <button type="submit" class="w-full md:w-1/2 py-2 px-4 text-white font-semibold bg-blue-600 rounded-md hover:bg-blue-700">Próximo</button>
                    </div>
                </form>
            </div>

            <!-- Tela 2: Seleção de Projeto -->
            <div id="project-selection-screen" class="hidden">
                 <h3 class="text-xl font-semibold mb-6 pb-2 border-b-2 border-gray-400 text-gray-700 text-center">2. Selecione o Projeto</h3>
                 <div id="project-buttons-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Botões serão inseridos aqui -->
                 </div>
                 <div class="text-center mt-8">
                    <button id="back-to-student-info" class="text-sm text-gray-600 hover:text-gray-800">&larr; Alterar dados do Extensionista</button>
                 </div>
            </div>

            <!-- Tela 3: Coleta de Dados do Público Alvo -->
            <div id="data-collection-screen" class="hidden">
                <form id="data-form" class="space-y-8">
                    <!-- Dados do Participante -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">3. Informações do Participante</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome do Participante</label>
                                <input type="text" id="participant-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Idade do Participante</label>
                                <input type="number" id="participant-age" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Sexo do Participante</label>
                                <select id="participant-sex" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white">
                                    <option value="">Selecione...</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Seção da Escala -->
                    <div id="questions-container">
                        <h3 id="questions-title" class="text-xl font-semibold mb-2">4. Escala CER-Breve-14</h3>
                        <p id="questions-intro" class="p-4 rounded-md italic">
                            <!-- Instrução inserida pelo JS -->
                        </p>
                        <div id="questions-list" class="space-y-6 mt-6">
                            <!-- Perguntas inseridas pelo JS -->
                        </div>
                    </div>

                    <!-- Seção de Submissão -->
                    <div class="text-center pt-4">
                        <div id="status-message" class="mb-4 font-semibold"></div>
                        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                             <button type="button" id="back-to-project-selection" class="text-sm text-gray-600 hover:text-gray-800 order-2 sm:order-1">&larr; Voltar para Seleção de Projeto</button>
                            <button type="submit" id="submit-button" class="w-full md:w-2/3 py-3 px-6 text-white font-bold text-lg rounded-lg shadow-md transition bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 order-1 sm:order-2">
                                Pré-visualizar Mensagem
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tela 4: Pré-visualização da Mensagem -->
            <div id="preview-screen" class="hidden">
                <h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 text-gray-700">5. Pré-visualização do E-mail</h3>
                <p class="text-sm text-gray-600 mb-4">Este é o corpo do e-mail que será enviado. Por favor, revise antes de continuar.</p>
                <div id="preview-message" class="email-preview">
                    <!-- Mensagem formatada será inserida aqui -->
                </div>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8">
                    <button type="button" id="back-to-form-btn" class="text-sm text-gray-600 hover:text-gray-800 order-2 sm:order-1">&larr; Voltar e Editar</button>
                    <button type="button" id="send-by-email-btn" class="w-full md:w-1/2 py-3 px-6 text-white font-bold text-lg rounded-lg shadow-md transition bg-green-600 hover:bg-green-700 order-1 sm:order-2">
                        Abrir Programa de E-mail
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuração dos Projetos e Perguntas ---
            const projectConfig = {
              idosos: { name: "Idosos Institucionalizados (Abrigo Lucas Zorn)", whatsapp: "5584994420139", color: "green", bgColor: "bg-green-50", textColor: "text-green-800", buttonColor: "bg-green-600", intro: "Vou te fazer umas perguntas bem simples sobre sua fé ou sua ligação com Deus, tá certo? Não tem resposta certa ou errada, é só o que você sente, tá bom?", questions: [ { id: 1, adaptada: "O(a) senhor(a) sentiu vontade de se aproximar mais de Deus, conversar mais com Ele nesses últimos tempos?" }, { id: 2, adaptada: "Teve momentos que o(a) senhor(a) sentiu que precisava do carinho ou da proteção de Deus?" }, { id: 3, adaptada: "Rezou ou conversou com Deus pedindo ajuda, conforto ou um conselho sobre o que fazer?" }, { id: 4, adaptada: "O(a) senhor(a) procurou se fortalecer em Deus quando as coisas estavam difíceis?" }, { id: 5, adaptada: "O(a) senhor(a) costuma rezar por outras pessoas, como amigos, família, colegas daqui do abrigo?" }, { id: 6, adaptada: "O(a) senhor(a) chegou a pensar que essa situação pode estar servindo pra te tornar mais forte com a ajuda de Deus?" }, { id: 7, adaptada: "Sentiu vontade de conversar com Deus pra pedir perdão por algo que acredita que fez de errado?" }, { id: 8, adaptada: "Teve algum momento que sentiu como se Deus tivesse te deixado sozinho(a)?" }, { id: 9, adaptada: "Já pensou se Deus realmente te ama ou se te esqueceu?" }, { id: 10, adaptada: "Já sentiu que Deus tá te castigando por algo?" }, { id: 11, adaptada: "Já ficou com raiva de Deus por tudo que tá passando?" }, { id: 12, adaptada: "Pensou que tudo isso que está vivendo pode ser um castigo de Deus?" }, { id: 13, adaptada: "Acredita que Deus está te provando ou testando com essa situação?" }, { id: 14, adaptada: "Teve dias em que ficou difícil acreditar ou confiar em Deus?" }, ] },
              cuidadores: { name: "Cuidadores de CRIANES (APAE)", whatsapp: "5583999992617", color: "pink", bgColor: "bg-pink-50", textColor: "text-pink-800", buttonColor: "bg-pink-600", intro: "A gente quer entender como a fé ajuda (ou não ajuda) no seu dia a dia com a criança. Pode responder como se estivesse contando sua rotina pra um amigo, tudo certo?", questions: [ { id: 1, adaptada: "Você buscou se aproximar mais de Deus nos momentos difíceis com seu filho(a)?" }, { id: 2, adaptada: "Sentiu que precisava da proteção de Deus diante dos desafios de cuidar da criança?" }, { id: 3, adaptada: "Você rezou ou meditou pedindo orientação ou consolo em situações difíceis?" }, { id: 4, adaptada: "Buscou forças em Deus para continuar luting pelo cuidado da criança?" }, { id: 5, adaptada: "Você costuma rezar por outras pessoas, como por seu(sua) filho(a), familiares ou amigos?" }, { id: 6, adaptada: "Já pensou que Deus pode estar te dando força para enfrentar tudo isso?" }, { id: 7, adaptada: "Você pediu perdão a Deus por algo que acha que poderia ter feito diferente?" }, { id: 8, adaptada: "Sentiu que Deus te deixou sozinha(o) nesse cuidado todo?" }, { id: 9, adaptada: "Já teve dúvida se Deus te ama mesmo diante de tanto sofrimento?" }, { id: 10, adaptada: "Você pensou que tudo isso pode ser um castigo de Deus?" }, { id: 11, adaptada: "Já ficou com raiva de Deus por tudo que está vivendo?" }, { id: 12, adaptada: "Acreditou que os problemas são um castigo?" }, { id: 13, adaptada: "Você sentiu que tudo isso é um teste de Deus pra você?" }, { id: 14, adaptada: "Teve dificuldade em acreditar ou confiar em Deus durante esse processo?" }, ] },
              dependentes: { name: "Usuários do CAPS AD (Dependentes Químicos)", whatsapp: "5583991007459", color: "orange", bgColor: "bg-orange-50", textColor: "text-orange-800", buttonColor: "bg-orange-600", intro: "A gente quer saber como a sua fé ou sua relação com Deus tem influenciado no seu tratamento. Pode responder com sinceridade, sem julgamento.", questions: [ { id: 1, adaptada: "Você tentou se aproximar mais de Deus nesse tempo de tratamento?" }, { id: 2, adaptada: "Buscou proteção e carinho de Deus nas horas difíceis?" }, { id: 3, adaptada: "Você orou, meditou ou conversou com Deus pedindo ajuda ou clareza?" }, { id: 4, adaptada: "Sentiu que precisava buscar forças em Deus pra vencer as recaídas ou a abstinência?" }, { id: 5, adaptada: "Você rezou por outras pessoas, como amigos, família ou colegas daqui do CAPS?" }, { id: 6, adaptada: "Pensou que, mesmo na dificuldade, Deus pode estar te fortalecendo?" }, { id: 7, adaptada: "Você pediu perdão a Deus por algo do seu passado?" }, { id: 8, adaptada: "Já teve a sensação de que Deus te deixou de lado?" }, { id: 9, adaptada: "Sentiu dúvida se Deus realmente se importa contigo?" }, { id: 10, adaptada: "Pensou que o vício ou as recaídas são um castigo de Deus?" }, { id: 11, adaptada: "Já sentiu raiva de Deus pelo que está passando?" }, { id: 12, adaptada: "Acreditou que tudo que passou é uma punição de Deus?" }, { id: 13, adaptada: "Sentiu que Deus estava te testando com as dificuldades?" }, { id: 14, adaptada: "Ficou difícil confiar em Deus em certos momentos?" }, ] },
            };
            const responseOptions = ["Nunca", "Raramente", "Às vezes", "Muitas vezes", "Sempre"];
            const responseMap = { "Nunca": 1, "Raramente": 2, "Às vezes": 3, "Muitas vezes": 4, "Sempre": 5 };

            // --- Estado da Aplicação ---
            let appState = {
                studentName: '',
                studentId: '',
                studentPhone: '',
                projectKey: '',
                mailtoUrl: '',
            };

            // --- Elementos da DOM ---
            const screens = {
                welcome: document.getElementById('welcome-screen'),
                manual: document.getElementById('manual-screen'),
                studentInfo: document.getElementById('student-info-screen'),
                projectSelection: document.getElementById('project-selection-screen'),
                dataCollection: document.getElementById('data-collection-screen'),
                preview: document.getElementById('preview-screen'),
            };
            const studentForm = document.getElementById('student-form');
            const projectButtonsContainer = document.getElementById('project-buttons-container');
            const dataForm = document.getElementById('data-form');
            const questionsIntro = document.getElementById('questions-intro');
            const questionsList = document.getElementById('questions-list');
            const statusMessage = document.getElementById('status-message');
            const backToStudentInfoBtn = document.getElementById('back-to-student-info');
            const backToProjectSelectionBtn = document.getElementById('back-to-project-selection');
            const previewMessageContainer = document.getElementById('preview-message');
            const sendByEmailBtn = document.getElementById('send-by-email-btn');
            const backToFormBtn = document.getElementById('back-to-form-btn');
            const showManualBtn = document.getElementById('show-manual-btn');
            const startCollectionBtn = document.getElementById('start-collection-btn');
            const backToWelcomeBtn = document.getElementById('back-to-welcome-btn');


            // --- Funções de Navegação ---
            const navigateTo = (screenName) => {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            };

            // --- Renderização e Lógica da UI ---
            
            Object.keys(projectConfig).forEach(key => {
                const project = projectConfig[key];
                const button = document.createElement('button');
                button.dataset.projectKey = key;
                button.className = `p-8 rounded-lg text-white font-bold text-lg shadow-lg transform transition hover:scale-105 bg-${project.color}-600`;
                button.textContent = project.name;
                button.addEventListener('click', () => {
                    appState.projectKey = key;
                    renderDataCollectionScreen(key);
                    navigateTo('dataCollection');
                });
                projectButtonsContainer.appendChild(button);
            });

            const renderDataCollectionScreen = (projectKey) => {
                const project = projectConfig[projectKey];
                questionsIntro.textContent = `Instrução: ${project.intro}`;
                questionsIntro.className = `p-4 rounded-md italic ${project.bgColor} ${project.textColor}`;
                
                questionsList.innerHTML = '';
                project.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'p-4 border border-gray-200 rounded-lg';
                    
                    const questionP = document.createElement('p');
                    questionP.className = 'font-semibold text-gray-800';
                    questionP.textContent = `${index + 1}. ${q.adaptada}`;
                    questionDiv.appendChild(questionP);

                    const radioContainer = document.createElement('div');
                    radioContainer.className = 'flex flex-wrap gap-x-4 gap-y-2 mt-3';

                    responseOptions.forEach((opt) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 text-gray-700 cursor-pointer';
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `question-${index}`;
                        radio.value = opt;
                        radio.required = true;
                        radio.className = `form-radio h-5 w-5 text-${project.color}-600`;
                        const span = document.createElement('span');
                        span.textContent = opt;
                        label.appendChild(radio);
                        label.appendChild(span);
                        radioContainer.appendChild(label);
                    });
                    questionDiv.appendChild(radioContainer);
                    questionsList.appendChild(questionDiv);
                });
            };

            // --- Lógica de Geração da Mensagem ---
            const getInterpretation = (score, type) => {
                if (type === 'positive') {
                    if (score <= 14) return "Muito baixo – espiritualidade pouco utilizada como recurso";
                    if (score <= 24) return "Moderado – espiritualidade usada de forma ocasional";
                    return "Alto – uso frequente e ativo da espiritualidade como coping";
                }
                if (type === 'negative') {
                    if (score <= 14) return "Muito baixo – poucos sentimentos negativos em relação à fé";
                    if (score <= 24) return "Moderado – ambivalência espiritual (dúvidas, conflitos)";
                    return "Alto – espiritualidade associada a sofrimento, culpa ou abandono";
                }
                return "";
            };

            const generatePreview = (formData) => {
                statusMessage.textContent = '';
                try {
                    const project = projectConfig[formData.projectKey];
                    
                    const numericResponses = formData.responses.map(r => responseMap[r] || 0);
                    const positiveScore = numericResponses.slice(0, 7).reduce((a, b) => a + b, 0);
                    const negativeScore = numericResponses.slice(7, 14).reduce((a, b) => a + b, 0);

                    const positiveInterpretation = getInterpretation(positiveScore, 'positive');
                    const negativeInterpretation = getInterpretation(negativeScore, 'negative');

                    let emailBody = `UNIVERSIDADE FEDERAL DE CAMPINA GRANDE\n`;
                    emailBody += `CENTRO DE FORMAÇÃO DE PROFESSORES\n`;
                    emailBody += `UNIDADE ACADÊMICA DE ENFERMAGEM\n`;
                    emailBody += `*PROGRAMA DE EXTENSÃO ESPIRITUALIDADE E SAÚDE MENTAL*\n\n`;
                    emailBody += `------------------------------------\n\n`;
                    emailBody += `*RELATÓRIO DE AVALIAÇÃO - CER-BREVE-14*\n\n`;
                    emailBody += `*Projeto:* ${project.name}\n`;
                    emailBody += `*Data:* ${new Date().toLocaleString('pt-BR')}\n\n`;
                    emailBody += `*Dados do Extensionista:*\n`;
                    emailBody += `Nome: ${formData.studentName}\n`;
                    emailBody += `Matrícula: ${formData.studentId}\n`;
                    emailBody += `Contato: ${formData.studentPhone}\n\n`;
                    emailBody += `*Dados do Participante:*\n`;
                    emailBody += `Nome: ${formData.participantName}\n`;
                    emailBody += `Idade: ${formData.participantAge}\n`;
                    emailBody += `Sexo: ${formData.participantSex}\n\n`;
                    emailBody += `*Resultados da Escala:*\n`;
                    emailBody += `CER Positivo (Itens 1-7): *${positiveScore}*\n`;
                    emailBody += `CER Negativo (Itens 8-14): *${negativeScore}*\n\n`;
                    emailBody += `*Perfil Espiritual (Interpretação):*\n`;
                    emailBody += `Coping Positivo: *${positiveInterpretation}*\n`;
                    emailBody += `Coping Negativo: *${negativeInterpretation}*\n\n`;
                    emailBody += `*Respostas Detalhadas:*\n`;
                    project.questions.forEach((q, index) => {
                        emailBody += `${index + 1}. ${q.adaptada}\n`;
                        emailBody += `   - Resposta: *${formData.responses[index]}*\n`;
                    });

                    previewMessageContainer.innerText = emailBody;
                    
                    const recipient = "probex2025.espiritualidade@gmail.com";
                    const subject = `Relatório do Projeto: ${project.name}`;
                    appState.mailtoUrl = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                    
                    navigateTo('preview');

                } catch (err) {
                    console.error("Preview Error:", err);
                    statusMessage.textContent = 'Houve um erro ao preparar a mensagem. Tente novamente.';
                    statusMessage.className = 'mb-4 font-semibold text-red-600';
                }
            };

            // --- Event Listeners ---
            showManualBtn.addEventListener('click', () => navigateTo('manual'));
            backToWelcomeBtn.addEventListener('click', () => navigateTo('welcome'));

            startCollectionBtn.addEventListener('click', () => {
                 const savedName = localStorage.getItem('studentName');
                const savedId = localStorage.getItem('studentId');
                const savedPhone = localStorage.getItem('studentPhone');

                if (savedName && savedId && savedPhone) {
                    appState.studentName = savedName;
                    appState.studentId = savedId;
                    appState.studentPhone = savedPhone;
                    
                    document.getElementById('student-name').value = savedName;
                    document.getElementById('student-id').value = savedId;
                    document.getElementById('student-phone').value = savedPhone;
                    navigateTo('projectSelection');
                } else {
                    navigateTo('studentInfo');
                }
            });

            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appState.studentName = document.getElementById('student-name').value;
                appState.studentId = document.getElementById('student-id').value;
                appState.studentPhone = document.getElementById('student-phone').value;
                
                localStorage.setItem('studentName', appState.studentName);
                localStorage.setItem('studentId', appState.studentId);
                localStorage.setItem('studentPhone', appState.studentPhone);

                navigateTo('projectSelection');
            });

            backToStudentInfoBtn.addEventListener('click', () => {
                localStorage.removeItem('studentName');
                localStorage.removeItem('studentId');
                localStorage.removeItem('studentPhone');
                navigateTo('studentInfo');
            });
            
            backToProjectSelectionBtn.addEventListener('click', () => navigateTo('projectSelection'));
            
            backToFormBtn.addEventListener('click', () => navigateTo('dataCollection'));

            sendByEmailBtn.addEventListener('click', () => {
                if (appState.mailtoUrl) {
                    dataForm.reset();
                    navigateTo('projectSelection');
                    window.location.href = appState.mailtoUrl;
                }
            });

            dataForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const participantData = {
                    participantName: document.getElementById('participant-name').value,
                    participantAge: document.getElementById('participant-age').value,
                    participantSex: document.getElementById('participant-sex').value,
                    responses: []
                };

                const project = projectConfig[appState.projectKey];
                for (let i = 0; i < project.questions.length; i++) {
                    const response = document.querySelector(`input[name="question-${i}"]:checked`);
                    if (response) {
                        participantData.responses.push(response.value);
                    } else {
                        statusMessage.textContent = `Por favor, responda a pergunta ${i + 1}.`;
                        statusMessage.className = 'mb-4 font-semibold text-red-600';
                        setTimeout(() => { statusMessage.textContent = ''; }, 3000);
                        return;
                    }
                }
                
                const fullData = { ...appState, ...participantData };
                generatePreview(fullData);
            });

            // --- Inicialização ---
            const initApp = () => {
                 document.getElementById('loading-screen').classList.add('hidden');
                 document.getElementById('app-container').classList.remove('hidden');
                 navigateTo('welcome');
            };

            initApp();
        });
    </script>
</body>
</html>
